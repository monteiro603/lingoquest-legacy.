<!-- Chosen Palette: Dynamic (Blue, Emerald, Rose, Slate) -->
<!-- Vers√£o Final Pronta para Produ√ß√£o com Termos de Servi√ßo Integrados -->

<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LingoQuest Pro: Legacy - Official Edition</title>
    
    <!-- PWA Essentials -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" id="theme-meta" content="#0284C7">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3892/3892250.png">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        :root { --primary: #0284C7; --primary-light: #E0F2FE; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; min-height: 100vh; transition: all 0.3s ease; }
        
        .theme-blue { --primary: #0284C7; --primary-light: #E0F2FE; }
        .theme-emerald { --primary: #059669; --primary-light: #D1FAE5; }
        .theme-rose { --primary: #E11D48; --primary-light: #FFE4E6; }
        .theme-slate { --primary: #334155; --primary-light: #F1F5F9; }

        .bg-style-default { background-color: #F8FAFC; color: #1E293B; }
        .bg-style-cream { background-color: #FFFBEB; color: #451a03; }
        .bg-style-dark { background-color: #0F172A; color: #F8FAFC; }

        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .bg-style-dark .glass { background: rgba(30, 41, 59, 0.85); border: 1px solid rgba(255, 255, 255, 0.05); }
        .bg-style-dark header, .bg-style-dark nav { background: #0F172A; border-color: #1e293b; }
        .bg-style-dark .bg-white { background-color: #1e293b; color: #f1f5f9; border-color: #334155; }
        
        .nav-active { color: var(--primary); transform: translateY(-4px); }
        .card-inner { position: relative; width: 100%; height: 320px; transition: transform 0.6s; transform-style: preserve-3d; cursor: pointer; }
        .card-inner.is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 32px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; border: 2px solid #E2E8F0; background: white; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.05); }
        .card-back { background: var(--primary); color: white; transform: rotateY(180deg); border: none; }
        
        .chat-bubble { max-width: 90%; padding: 14px 18px; border-radius: 24px; font-size: 14px; line-height: 1.6; white-space: pre-wrap; }
        .bubble-bot { background: white; border: 1px solid #E2E8F0; color: #334155; }
        .bg-style-dark .bubble-bot { background: #1e293b; color: white; border-color: #334155; }
        .bubble-user { background: var(--primary); color: white; align-self: flex-end; }
        
        .view-animate { animation: fadeInUp 0.4s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .ai-loading { display: inline-block; width: 18px; height: 18px; border: 3px solid rgba(0,0,0,0.1); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .ad-simulation-overlay { position: fixed; inset: 0; z-index: 200; background: black; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 300; display: flex; align-items: center; justify-content: center; padding: 1.5rem; }
        
        input { border: 1px solid #E2E8F0; padding: 12px 16px; border-radius: 12px; font-size: 14px; outline: none; transition: border 0.2s; }
        input:focus { border-color: var(--primary); }
    </style>
</head>
<body class="pb-32 theme-blue bg-style-default">

    <!-- Modal de Confirma√ß√£o -->
    <div id="modal-container" class="modal-overlay hidden">
        <div class="bg-white rounded-[2.5rem] w-full max-w-sm p-8 shadow-2xl">
            <h3 id="modal-title" class="text-xl font-black mb-2 text-slate-800">Confirmar</h3>
            <p id="modal-text" class="text-sm text-slate-500 mb-8 leading-relaxed"></p>
            <div class="flex space-x-3">
                <button onclick="closeModal()" class="flex-1 py-4 bg-slate-100 text-slate-600 rounded-2xl font-bold">Cancelar</button>
                <button id="modal-confirm-btn" class="flex-1 py-4 bg-primary text-white rounded-2xl font-bold shadow-lg">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- Toast de Notifica√ß√£o -->
    <div id="toast-notif" class="fixed top-8 left-1/2 -translate-x-1/2 z-[400] bg-slate-900 text-white px-6 py-3 rounded-full text-xs font-bold shadow-2xl hidden"></div>

    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center p-8 overflow-y-auto">
        <div class="w-full max-w-sm text-center">
            <div class="mb-6">
                <svg class="w-12 h-12 mx-auto mb-4" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="50" fill="#0284C7"/>
                    <path d="M30 50L45 65L70 35" stroke="white" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <h1 class="text-3xl font-black text-[#0284C7] tracking-tighter mb-1">LingoQuest<br><span class="text-emerald-500 text-2xl uppercase tracking-widest">Legacy Pro</span></h1>
                <p class="text-slate-400 text-xs italic">Cria a tua conta oficial.</p>
            </div>

            <div class="flex bg-slate-100 p-1 rounded-xl mb-6">
                <button onclick="toggleAuthMode('login')" id="tab-login" class="flex-1 py-2 text-xs font-bold rounded-lg bg-white shadow-sm transition-all">Login</button>
                <button onclick="toggleAuthMode('register')" id="tab-register" class="flex-1 py-2 text-xs font-bold text-slate-400 transition-all">Registo</button>
            </div>

            <div class="flex flex-col space-y-3 mb-6">
                <input type="email" id="auth-email" placeholder="O teu e-mail" class="w-full">
                <input type="password" id="auth-password" placeholder="Password (min. 6 carateres)" class="w-full">
                <button id="btn-auth-submit" class="w-full py-4 bg-primary text-white rounded-2xl font-black text-sm uppercase shadow-lg shadow-sky-200">Entrar</button>
            </div>

            <div class="flex items-center my-6">
                <div class="flex-1 h-px bg-slate-100"></div>
                <span class="px-4 text-[10px] text-slate-300 font-bold uppercase">Ou continuar com</span>
                <div class="flex-1 h-px bg-slate-100"></div>
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button id="btn-login-google" class="py-3 px-4 bg-white border border-slate-200 rounded-xl flex items-center justify-center space-x-2 active:scale-95 transition-all">
                    <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" class="w-4 h-4">
                    <span class="text-xs font-bold text-slate-600">Google</span>
                </button>
                <button id="btn-login-guest" class="py-3 px-4 bg-slate-50 border border-slate-100 rounded-xl flex items-center justify-center space-x-2 active:scale-95 transition-all">
                    <span class="text-lg">üë§</span>
                    <span class="text-xs font-bold text-slate-500">Convidado</span>
                </button>
            </div>
            
            <p id="auth-error-msg" class="mt-4 text-[10px] text-rose-500 font-bold hidden"></p>
        </div>
    </div>

    <!-- UI Principal -->
    <div id="main-ui" class="hidden">
        <header class="p-6 flex justify-between items-center glass sticky top-0 z-40 border-b border-slate-100">
            <div id="header-logo-container" class="cursor-pointer">
                <h1 class="text-xl font-extrabold text-primary tracking-tighter leading-none">LingoQuest <span class="text-emerald-500">Legacy</span></h1>
                <div class="flex items-center space-x-2 mt-1">
                    <div class="bg-orange-500 text-white px-2 py-0.5 rounded text-[8px] font-bold">üî• <span id="ui-streak">0</span></div>
                    <span class="text-[8px] font-bold text-slate-400 uppercase tracking-widest italic">Play Store Version</span>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <div class="bg-amber-100 px-3 py-1.5 rounded-2xl text-amber-600 font-extrabold text-sm border border-amber-200">
                    üíé <span id="ui-gems">0</span>
                </div>
            </div>
        </header>

        <main id="app-viewport" class="px-6 py-4 max-w-lg mx-auto min-h-[60vh]"></main>

        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 px-6 py-4 flex justify-between items-center z-50 shadow-2xl">
            <button onclick="changeView('home')" id="nav-home" class="flex flex-col items-center transition-all nav-active"><span class="text-2xl">üè†</span></button>
            <button onclick="changeView('flashcards')" id="nav-flashcards" class="flex flex-col items-center transition-all text-slate-400"><span class="text-2xl">üìö</span></button>
            <button onclick="changeView('tutor')" id="nav-tutor" class="flex flex-col items-center transition-all text-slate-400"><span class="text-2xl">ü§ñ</span></button>
            <button onclick="changeView('grammar')" id="nav-grammar" class="flex flex-col items-center transition-all text-slate-400"><span class="text-2xl">‚úçÔ∏è</span></button>
            <button onclick="changeView('store')" id="nav-store" class="flex flex-col items-center transition-all text-slate-400"><span class="text-2xl">üè™</span></button>
            <button onclick="changeView('settings')" id="nav-settings" class="flex flex-col items-center transition-all text-slate-400"><span class="text-2xl">‚öôÔ∏è</span></button>
        </nav>
    </div>

    <!-- Simulador de AdMob Overlay -->
    <div id="ad-overlay" class="ad-simulation-overlay hidden">
        <div class="absolute top-6 right-6 text-xs font-bold text-white/40" id="ad-timer">An√∫ncio acaba em 5s...</div>
        <div class="text-center p-8">
            <div class="text-6xl mb-6">üì∫</div>
            <h3 class="text-xl font-black mb-2 uppercase">AdMob Video Ad</h3>
            <div class="w-64 h-2 bg-white/10 rounded-full overflow-hidden">
                <div id="ad-progress" class="bg-primary h-full w-0 transition-all duration-[5000ms] ease-linear"></div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- Firebase Config ---
        const envConfig = window.__firebase_config ? JSON.parse(window.__firebase_config) : null;
        const firebaseConfig = envConfig || { apiKey: "", authDomain: "", projectId: "", storageBucket: "", messagingSenderId: "", appId: "" };
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'lingoquest-legacy-pro';
        
        const geminiApiKey = ""; 
        const geminiModel = "gemini-2.5-flash-preview-09-2025";

        let auth, db;
        if (firebaseConfig.apiKey) {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (e) { console.error("Firebase Init Error", e); }
        }

        let state = {
            user: null, xp: 0, gems: 0, streak: 0, totalTimeMinutes: 0, lastLoginDate: null, sessionStartTime: Date.now(),
            level: 'basic', view: 'home', theme: 'theme-blue', bgStyle: 'bg-style-default', cardIdx: 0,
            chatMessages: [], grammarAnalysis: null, dailyMission: null, immersiveContext: null,
            unlockedLevels: ['basic'],
            achievements: { 'first_step': true, 'scholar': false, 'master': false }
        };

        const LEVEL_COSTS = { basic: 0, intermediate: 200, advanced_tech: 500 };

        const GAME_DATA = {
            basic: { cards: [{en: "I am a teacher", pt: "Eu sou professor(a)", cat: "Pilar: B√°sico"}, {en: "Do you like coffee?", pt: "Gostas de caf√©?", cat: "Pilar: B√°sico"}] },
            intermediate: { cards: [{en: "I have finished my homework", pt: "Eu terminei o meu TPC", cat: "Tempo: Interm√©dio"}, {en: "If it rains, I'll stay at home", pt: "Se chover, ficarei em casa", cat: "Gram√°tica: Interm√©dio"}] },
            advanced_tech: { cards: [{en: "To charter", pt: "Fretar (Navio/Carga)", cat: "Avan√ßado T√©cnico (PDF)"}, {en: "Toxic Gas", pt: "G√°s T√≥xico", cat: "Dangerous Cargo"}, {en: "To containerize", pt: "Conteinerizar", cat: "Verbos Mar√≠timos"}] }
        };

        // --- Auth Implementation ---
        let authMode = 'login';
        window.toggleAuthMode = (mode) => {
            authMode = mode;
            const btn = document.getElementById('btn-auth-submit');
            const tabLogin = document.getElementById('tab-login');
            const tabRegister = document.getElementById('tab-register');
            if (mode === 'login') {
                btn.textContent = 'Entrar';
                tabLogin.className = 'flex-1 py-2 text-xs font-bold rounded-lg bg-white shadow-sm';
                tabRegister.className = 'flex-1 py-2 text-xs font-bold text-slate-400';
            } else {
                btn.textContent = 'Criar Conta';
                tabRegister.className = 'flex-1 py-2 text-xs font-bold rounded-lg bg-white shadow-sm';
                tabLogin.className = 'flex-1 py-2 text-xs font-bold text-slate-400';
            }
        };

        const showError = (msg) => {
            const el = document.getElementById('auth-error-msg');
            el.textContent = msg; el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        };

        if (auth) {
            onAuthStateChanged(auth, (user) => {
                if (user) { 
                    state.user = user; syncUserData(user.uid); 
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('main-ui').classList.remove('hidden');
                    changeView('home');
                } else { 
                    document.getElementById('auth-screen').classList.remove('hidden');
                    document.getElementById('main-ui').classList.add('hidden');
                }
            });
        }

        document.getElementById('btn-auth-submit').onclick = async () => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            if (!email || password.length < 6) return showError("Dados inv√°lidos.");
            try {
                if (authMode === 'login') await signInWithEmailAndPassword(auth, email, password);
                else await createUserWithEmailAndPassword(auth, email, password);
            } catch (e) { showError(e.message); }
        };

        document.getElementById('btn-login-google').onclick = async () => {
            const provider = new GoogleAuthProvider();
            try { await signInWithPopup(auth, provider); } catch (e) { showError(e.message); }
        };

        document.getElementById('btn-login-guest').onclick = () => {
            if (auth) signInAnonymously(auth); else enterGuestMode();
        };

        function enterGuestMode() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-ui').classList.remove('hidden');
            changeView('home');
        }

        // --- Data Handling ---
        async function syncUserData(uid) {
            if (!db) return;
            const userDocRef = doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data');
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) { 
                    const data = docSnap.data();
                    const { user, ...rest } = data; 
                    Object.assign(state, rest); 
                    updateUI(); 
                } else { saveData(); }
            }, (err) => console.error("Sync Error", err));
        }

        async function saveData() {
            if (!state.user || !db) return;
            const userDocRef = doc(db, 'artifacts', appId, 'users', state.user.uid, 'profile', 'data');
            const dataToSave = { ...state };
            delete dataToSave.user; 
            try { await setDoc(userDocRef, { ...dataToSave, updatedAt: new Date().toISOString() }, { merge: true }); } catch (e) { console.error("Save Error", e); }
        }

        // --- App Views ---
        window.changeView = (view) => {
            state.view = view;
            const viewport = document.getElementById('app-viewport');
            
            // Gest√£o visual da navega√ß√£o
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.remove('nav-active'); b.classList.add('text-slate-400');
            });
            const navBtn = document.getElementById(`nav-${view}`);
            if (navBtn) { navBtn.classList.add('nav-active'); navBtn.classList.remove('text-slate-400'); }
            
            viewport.innerHTML = '';
            updateUI();
            
            switch(view) {
                case 'home': renderHome(viewport); break;
                case 'flashcards': renderFlashcards(viewport); break;
                case 'tutor': renderTutor(viewport); break;
                case 'grammar': renderGrammar(viewport); break;
                case 'store': renderStore(viewport); break;
                case 'settings': renderSettings(viewport); break;
                case 'terms': renderTerms(viewport); break;
            }
        };

        function renderHome(v) {
            v.innerHTML = `
                <div class="view-animate">
                    <div class="bg-primary rounded-[2.5rem] p-8 text-white shadow-xl mb-6 relative overflow-hidden">
                        <h2 class="text-2xl font-bold mb-1 italic">Ol√°, Explorador!</h2>
                        <p class="text-white/70 text-[10px] uppercase font-bold tracking-widest">XP Total: ${state.xp}</p>
                        <div class="mt-6 bg-white/20 h-2 rounded-full overflow-hidden"><div class="bg-white h-full" style="width: ${(state.xp % 100)}%"></div></div>
                    </div>
                    <div class="grid grid-cols-1 gap-4">
                        ${renderLevelBtn('basic', 'B√°sico', 'üå±')}
                        ${renderLevelBtn('intermediate', 'Interm√©dio', 'üèÜ')}
                        ${renderLevelBtn('advanced_tech', 'Avan√ßado T√©cnico ‚ú®', 'üö¢')}
                    </div>
                </div>
            `;
        }

        function renderLevelBtn(id, label, icon) {
            const isUnlocked = state.unlockedLevels.includes(id);
            const cost = LEVEL_COSTS[id];
            return `
                <button onclick="handleLevelSelection('${id}')" class="p-6 bg-white rounded-3xl border-2 ${isUnlocked ? 'border-primary' : 'border-slate-100 opacity-60'} shadow-sm flex items-center justify-between">
                    <div class="text-left"><p class="font-black text-slate-700 uppercase text-xs">${label}</p><p class="text-[9px] text-slate-400">${isUnlocked ? 'Desbloqueado' : 'Custo: ' + cost + ' Gemas'}</p></div>
                    <span class="text-2xl">${isUnlocked ? icon : 'üîí'}</span>
                </button>
            `;
        }

        window.handleLevelSelection = (lvlId) => {
            if (state.unlockedLevels.includes(lvlId)) { state.level = lvlId; state.cardIdx = 0; changeView('flashcards'); }
            else {
                const cost = LEVEL_COSTS[lvlId];
                if (state.gems >= cost) {
                    document.getElementById('modal-text').textContent = `Queres desbloquear ${lvlId} por ${cost} gemas?`;
                    document.getElementById('modal-container').classList.remove('hidden');
                    document.getElementById('modal-confirm-btn').onclick = () => {
                        state.gems -= cost; state.unlockedLevels.push(lvlId); 
                        closeModal(); showToast("N√≠vel Desbloqueado!"); updateUI(); saveData(); changeView('home');
                    };
                } else { showToast("Gemas insuficientes!"); changeView('store'); }
            }
        };

        function renderFlashcards(v) {
            const card = GAME_DATA[state.level].cards[state.cardIdx];
            v.innerHTML = `
                <div class="view-animate text-center">
                    <div id="card-box" class="card-container mb-8">
                        <div class="card-inner">
                            <div class="card-face"><span class="text-[10px] font-bold text-slate-400 mb-6 uppercase">${card.cat}</span><h3 class="text-3xl font-black text-primary px-4">${card.en}</h3></div>
                            <div class="card-back card-face"><span class="text-[10px] font-bold text-white/50 mb-6 uppercase">Tradu√ß√£o</span><h3 class="text-2xl font-bold text-white px-4">${card.pt}</h3></div>
                        </div>
                    </div>
                    <button id="btn-next" class="w-full py-4 bg-primary text-white rounded-2xl font-bold shadow-lg">Pr√≥ximo (+10 XP)</button>
                </div>
            `;
            document.getElementById('card-box').onclick = () => {
                document.querySelector('.card-inner').classList.toggle('is-flipped');
                const u = new SpeechSynthesisUtterance(card.en); u.lang = 'en-US'; window.speechSynthesis.speak(u);
            };
            document.getElementById('btn-next').onclick = () => {
                state.xp += 10; state.cardIdx = (state.cardIdx + 1) % GAME_DATA[state.level].cards.length;
                changeView('flashcards'); saveData();
            };
        }

        function renderTutor(v) {
            v.innerHTML = `
                <div class="view-animate flex flex-col h-full" style="height: calc(100vh - 250px);">
                    <div id="chat-win" class="flex-1 overflow-y-auto space-y-4 p-4 bg-white/50 rounded-3xl border border-slate-100 min-h-[350px]">
                        ${state.chatMessages.map(m => `<div class="flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}"><div class="chat-bubble ${m.role === 'user' ? 'bubble-user' : 'bubble-bot'} shadow-sm">${m.text}</div></div>`).join('') || '<p class="text-center py-20 text-slate-400 text-sm">Pergunta algo sobre ingl√™s!</p>'}
                    </div>
                    <div class="mt-4 flex space-x-2 bg-white p-2 rounded-2xl shadow-sm border">
                        <input id="chat-in" type="text" placeholder="Escreve aqui..." class="flex-1 p-3 outline-none text-sm bg-transparent">
                        <button id="btn-send" class="p-3 px-6 bg-primary text-white rounded-xl font-bold">‚ö°</button>
                    </div>
                </div>
            `;
            document.getElementById('chat-win').scrollTop = 9999;
            document.getElementById('btn-send').onclick = async () => {
                const input = document.getElementById('chat-in');
                const text = input.value.trim(); if (!text) return;
                state.chatMessages.push({ role: 'user', text }); input.value = '';
                renderTutor(document.getElementById('app-viewport'));
                const response = await callGemini(text, "Foca na aprendizagem profissional.");
                state.chatMessages.push({ role: 'bot', text: response });
                renderTutor(document.getElementById('app-viewport'));
            };
        }

        function renderGrammar(v) {
            v.innerHTML = `
                <div class="view-animate">
                    <h2 class="text-2xl font-black mb-4">Analisar Frases ‚ú®</h2>
                    <textarea id="gram-in" placeholder="Escreve uma frase..." class="w-full h-32 p-4 rounded-3xl bg-white border outline-none text-sm mb-4 shadow-sm"></textarea>
                    <button id="btn-gram" class="w-full py-4 bg-primary text-white rounded-2xl font-bold shadow-lg">Analisar ‚ú®</button>
                    <div id="gram-res" class="mt-6 ${state.grammarAnalysis ? '' : 'hidden'} pb-10">
                        <div class="bg-white p-6 rounded-3xl border text-sm chat-bubble bubble-bot w-full leading-relaxed">${state.grammarAnalysis || ''}</div>
                    </div>
                </div>
            `;
            document.getElementById('btn-gram').onclick = async () => {
                const input = document.getElementById('gram-in').value; if (!input) return;
                document.getElementById('btn-gram').innerHTML = '<div class="ai-loading border-t-white"></div>';
                state.grammarAnalysis = await callGemini(`Corrige: "${input}".`);
                renderGrammar(document.getElementById('app-viewport'));
            };
        }

        function renderStore(v) {
            v.innerHTML = `
                <div class="view-animate">
                    <h2 class="text-2xl font-black mb-6">Loja üíé</h2>
                    <div class="bg-emerald-500 rounded-[2.5rem] p-8 text-white mb-6">
                        <h3 class="font-bold text-lg mb-1">Gemas Gr√°tis</h3>
                        <button onclick="watchAdReward()" class="w-full py-4 bg-white text-emerald-600 rounded-2xl font-black text-sm mt-4 uppercase">Ver V√≠deo (+50 üíé)</button>
                    </div>
                </div>
            `;
        }

        window.watchAdReward = () => {
            const overlay = document.getElementById('ad-overlay');
            overlay.classList.remove('hidden');
            setTimeout(() => {
                overlay.classList.add('hidden');
                state.gems += 50; showToast("+50 Gemas!"); updateUI(); saveData();
            }, 5000);
        };

        function renderSettings(v) {
            v.innerHTML = `
                <div class="view-animate space-y-6">
                    <h2 class="text-2xl font-black">Defini√ß√µes ‚öôÔ∏è</h2>
                    <div class="bg-primary/5 p-6 rounded-3xl border">
                        <p class="text-[10px] font-bold text-primary uppercase mb-2 tracking-widest">Conta Oficial</p>
                        <p class="text-xs text-slate-500 mb-6">${state.user?.email || "Convidado An√≥nimo"}</p>
                        
                        <div class="space-y-2">
                            <button onclick="changeView('terms')" class="w-full py-4 bg-white text-slate-700 rounded-2xl font-bold border text-sm">Ver Termos de Servi√ßo</button>
                            <button onclick="handleLogout()" class="w-full py-4 bg-rose-50 text-rose-600 rounded-2xl font-bold border border-rose-100 text-sm">Terminar Sess√£o</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTerms(v) {
            v.innerHTML = `
                <div class="view-animate pb-10">
                    <div class="flex items-center space-x-4 mb-6">
                        <button onclick="changeView('settings')" class="text-primary font-bold">‚Üê Voltar</button>
                        <h2 class="text-xl font-black">Termos de Servi√ßo</h2>
                    </div>
                    
                    <div class="bg-white p-6 rounded-3xl border text-xs text-slate-600 space-y-4 leading-relaxed max-h-[60vh] overflow-y-auto">
                        <p><strong>1. Aceita√ß√£o:</strong> Ao usar o LingoQuest Pro, aceitas estes termos.</p>
                        <p><strong>2. Servi√ßo:</strong> O Tutor IA √© baseado no Google Gemini e pode conter imprecis√µes.</p>
                        <p><strong>3. Contas:</strong> √â respons√°vel por manter a seguran√ßa dos seus dados de acesso.</p>
                        <p><strong>4. Gemas:</strong> Itens virtuais sem valor monet√°rio real. N√£o reembols√°veis.</p>
                        <p><strong>5. Conduta:</strong> Proibido o uso de linguagem abusiva no chat.</p>
                        <p><strong>6. Responsabilidade:</strong> N√£o nos responsabilizamos por perdas de dados em contas de convidado.</p>
                        <hr class="border-slate-100">
                        <p class="text-[10px] italic">√öltima atualiza√ß√£o: Janeiro 2026</p>
                    </div>
                </div>
            `;
        }

        window.handleLogout = () => { if(auth) signOut(auth); else location.reload(); };

        window.showToast = (msg) => {
            const t = document.getElementById('toast-notif');
            if (t) { t.textContent = msg; t.classList.remove('hidden'); }
            setTimeout(() => t && t.classList.add('hidden'), 3000);
        };
        window.closeModal = () => {
            const m = document.getElementById('modal-container');
            if (m) m.classList.add('hidden');
        };
        function updateUI() {
            const g = document.getElementById('ui-gems');
            const s = document.getElementById('ui-streak');
            if(g) g.textContent = state.gems;
            if(s) s.textContent = state.streak;
            document.body.className = `pb-32 ${state.theme} ${state.bgStyle}`;
        }

        // PWA SW Activation
        if ('serviceWorker' in navigator && (window.location.protocol === 'http:' || window.location.protocol === 'https:')) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js').catch(err => console.debug('SW skipped', err));
            });
        }
    </script>
</body>
</html>
