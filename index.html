
<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LingoQuest Pro: Legacy - Ultimate Edition</title>
    
    <!-- PWA Essentials -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" id="theme-meta" content="#0284C7">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3892/3892250.png">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInWithPopup, GoogleAuthProvider, signInAnonymously, signInWithCustomToken, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = JSON.parse(window.__firebase_config || '{}');
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'lingoquest-legacy-pro';
        const authToken = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null;

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const googleProvider = new GoogleAuthProvider();

        window.db = db;
        window.auth = auth;
        window.appId = appId;
        window.googleProvider = googleProvider;
        window.signInWithPopup = signInWithPopup;
        window.signInAnonymously = signInAnonymously;
        window.signInWithCustomToken = signInWithCustomToken;
        window.signOut = signOut;
        window.collection = collection;

        const initAuth = async () => {
            try {
                if (authToken) {
                    await signInWithCustomToken(auth, authToken);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (error) {
                console.error("Erro na autentica√ß√£o:", error);
            }
        };
        initAuth();

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('./service-worker.js')
                    .then(reg => console.log('SW registrado!', reg))
                    .catch(err => console.log('Erro no SW', err));
            });
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        :root {
            --primary: #0284C7;
            --primary-light: #E0F2FE;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            min-height: 100vh;
            transition: all 0.3s ease; 
        }
        
        .theme-blue { --primary: #0284C7; --primary-light: #E0F2FE; }
        .theme-emerald { --primary: #059669; --primary-light: #D1FAE5; }
        .theme-rose { --primary: #E11D48; --primary-light: #FFE4E6; }
        .theme-slate { --primary: #334155; --primary-light: #F1F5F9; }

        .bg-style-default { background-color: #F8FAFC; color: #1E293B; }
        .bg-style-cream { background-color: #FFFBEB; color: #451a03; }
        .bg-style-dark { background-color: #0F172A; color: #F8FAFC; }
        .bg-style-gradient-sky { background: linear-gradient(135deg, #E0F2FE 0%, #F8FAFC 100%); color: #1E293B; }
        .bg-style-gradient-sunset { background: linear-gradient(135deg, #FFE4E6 0%, #FFFBEB 100%); color: #451a03; }

        .text-primary { color: var(--primary); }
        .bg-primary { background-color: var(--primary); }
        .bg-primary-light { background-color: var(--primary-light); }
        .border-primary { border-color: var(--primary); }

        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .bg-style-dark .glass { background: rgba(30, 41, 59, 0.85); border: 1px solid rgba(255, 255, 255, 0.05); }
        .bg-style-dark header, .bg-style-dark nav { background: rgba(15, 23, 42, 0.95); border-color: #1e293b; }
        .bg-style-dark .bg-white { background-color: #1e293b; color: #f1f5f9; border-color: #334155; }
        
        .nav-active { color: var(--primary); transform: translateY(-4px); }
        
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .view-animate { animation: fadeInUp 0.4s ease-out; }
        
        .ai-loading {
            display: inline-block; width: 18px; height: 18px; border: 3px solid rgba(0,0,0,0.1); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s linear infinite;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        .card-inner { position: relative; width: 100%; height: 350px; transition: transform 0.6s; transform-style: preserve-3d; cursor: pointer; }
        .card-inner.is-flipped { transform: rotateY(180deg); }
        .card-face { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 32px; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 2rem; border: 2px solid #E2E8F0; background: white; }
        .bg-style-dark .card-face { background: #1e293b; border-color: #334155; }
        .card-back { background: var(--primary); color: white; transform: rotateY(180deg); border: none; }

        .chat-bubble { max-width: 90%; padding: 14px 18px; border-radius: 24px; font-size: 14px; line-height: 1.6; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); white-space: pre-wrap; }
        .bubble-bot { background: white; border: 1px solid #E2E8F0; border-bottom-left-radius: 4px; color: #334155; }
        .bg-style-dark .bubble-bot { background: #334155; border-color: #475569; color: #f1f5f9; }
        .bubble-user { background: var(--primary); color: white; border-bottom-right-radius: 4px; align-self: flex-end; }

        .rank-gold { background: linear-gradient(135deg, #FDE68A 0%, #F59E0B 100%); color: #78350F; border: 2px solid #FBBF24; box-shadow: 0 0 15px rgba(245, 158, 11, 0.3); }
        .rank-silver { background: linear-gradient(135deg, #E2E8F0 0%, #94A3B8 100%); color: #1E293B; border: 2px solid #CBD5E1; }
        .rank-bronze { background: linear-gradient(135deg, #FFEDD5 0%, #D97706 100%); color: #7C2D12; border: 2px solid #FDBA74; }
        
        .streak-badge { background: linear-gradient(to bottom, #FF8C00, #FF4500); color: white; padding: 2px 8px; border-radius: 10px; font-size: 10px; font-weight: 800; display: flex; align-items: center; gap: 4px; }
        .logo-svg { width: 42px; height: 42px; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.1)); }
    </style>
</head>
<body class="pb-32 theme-blue bg-style-default">

    <!-- Auth Screen -->
    <div id="auth-screen" class="fixed inset-0 z-[100] bg-white flex flex-col items-center justify-center p-8 text-center">
        <div class="mb-8">
            <svg class="logo-svg mx-auto mb-4" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="50" fill="url(#grad1)"/>
                <path d="M30 50L45 65L70 35" stroke="white" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"/>
                <defs>
                    <linearGradient id="grad1" x1="0" y1="0" x2="100" y2="100" gradientUnits="userSpaceOnUse">
                        <stop stop-color="#0EA5E9"/>
                        <stop offset="1" stop-color="#10B981"/>
                    </linearGradient>
                </defs>
            </svg>
            <h1 class="text-3xl font-black text-primary tracking-tighter mb-2">LingoQuest<br><span class="text-emerald-500 text-4xl uppercase tracking-widest">Legacy Pro</span></h1>
            <p class="text-slate-400 text-sm italic">Honrando as origens, dominando o futuro.</p>
        </div>
        <div class="w-full max-w-sm space-y-4">
            <button onclick="loginWithGoogle()" class="w-full flex items-center justify-center space-x-3 py-4 bg-white border-2 border-slate-100 rounded-2xl font-bold text-slate-700 shadow-sm transition-all active:scale-95">
                <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/action/google.svg" class="w-6 h-6" alt="Google">
                <span>Entrar com Gmail</span>
            </button>
            <button onclick="loginAnonymously()" class="w-full py-4 bg-slate-50 text-slate-400 rounded-2xl font-bold text-xs uppercase border border-slate-100 active:scale-95 transition-all">Visitante</button>
        </div>
    </div>

    <!-- Main UI -->
    <div id="main-ui" class="hidden">
        <header class="p-6 flex justify-between items-center glass sticky top-0 z-40 border-b border-slate-100">
            <div onclick="changeView('home')" class="cursor-pointer flex items-center space-x-3">
                <svg class="w-9 h-9" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="50" fill="var(--primary)"/>
                    <path d="M30 50L45 65L70 35" stroke="white" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <div>
                    <h1 class="text-lg font-extrabold text-primary tracking-tighter leading-none">LingoQuest <span class="text-emerald-500">Legacy</span></h1>
                    <div class="flex items-center space-x-2 mt-1">
                        <div id="streak-container" class="streak-badge">üî• <span id="ui-streak-count">0</span></div>
                        <span id="ui-current-lvl-tag" class="text-[8px] font-bold text-slate-400 uppercase tracking-widest italic">Legacy Pro Edition</span>
                    </div>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <button onclick="changeView('settings')" class="w-10 h-10 flex items-center justify-center rounded-xl bg-slate-100 text-slate-500 shadow-sm">‚öôÔ∏è</button>
                <div class="bg-amber-100 px-3 py-1.5 rounded-2xl border border-amber-200 flex items-center shadow-sm">
                    <span class="text-amber-600 font-extrabold text-sm">üíé <span id="ui-gems-count">0</span></span>
                </div>
            </div>
        </header>

        <main id="app-viewport" class="px-6 py-4 max-w-lg mx-auto min-h-[60vh]"></main>

        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-100 px-6 py-4 flex justify-between items-center z-50 shadow-2xl">
            <button onclick="changeView('home')" id="nav-home" class="flex flex-col items-center transition-all nav-active">
                <span class="text-2xl">üè†</span>
                <span id="nav-txt-home" class="text-[9px] font-bold uppercase mt-1">In√≠cio</span>
            </button>
            <button onclick="changeView('flashcards')" id="nav-flashcards" class="flex flex-col items-center transition-all text-slate-400">
                <span class="text-2xl">üìö</span>
                <span id="nav-txt-study" class="text-[9px] font-bold uppercase mt-1">Estudo</span>
            </button>
            <button onclick="changeView('tutor')" id="nav-tutor-btn" class="flex flex-col items-center transition-all text-slate-400">
                <span class="text-2xl">ü§ñ</span>
                <span id="nav-txt-tutor" class="text-[9px] font-bold uppercase mt-1">IA Tutor</span>
            </button>
            <button onclick="changeView('grammar')" id="nav-grammar" class="flex flex-col items-center transition-all text-slate-400">
                <span class="text-2xl">‚úçÔ∏è</span>
                <span id="nav-txt-grammar" class="text-[9px] font-bold uppercase mt-1 text-inherit">Gram√°tica</span>
            </button>
            <button onclick="changeView('ranking')" id="nav-ranking" class="flex flex-col items-center transition-all text-slate-400">
                <span class="text-2xl">üèÜ</span>
                <span id="nav-txt-ranking" class="text-[9px] font-bold uppercase mt-1">Ranking</span>
            </button>
        </nav>
    </div>

    <script type="module">
        import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { doc, setDoc, onSnapshot, getDoc, collection } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const apiKey = "";
        const geminiModel = "gemini-2.5-flash-preview-09-2025";

        const I18N = {
            pt: { home: "In√≠cio", study: "Estudo", tutor: "IA Tutor", grammar: "Gram√°tica", ranking: "Ranking", settings: "Defini√ß√µes", level: "N√≠vel", basic: "B√°sico", inter: "Interm√©dio", adv: "Avan√ßado", welcome: "Bem-vindo", example: "Exemplo IA", next: "Pr√≥ximo", prev: "Anterior", listen: "Ouvir", reset: "Reiniciar Tudo", analyze: "Analisar", analyzing: "Analisando...", placeholder_grammar: "Escreve o teu texto em ingl√™s...", bg_style: "Estilo de Fundo" },
            en: { home: "Home", study: "Study", tutor: "AI Tutor", grammar: "Grammar", ranking: "Ranking", settings: "Settings", level: "Level", basic: "Basic", inter: "Intermediate", adv: "Advanced", welcome: "Welcome", example: "AI Example", next: "Next", prev: "Prev", listen: "Listen", reset: "Reset All", analyze: "Analyze", analyzing: "Analyzing...", placeholder_grammar: "Write your English text...", bg_style: "Background Style" }
        };

        const GAME_DATA = {
            basic: { label_key: "basic", cost: 0, cards: [{en: "Knowledge", pt: "Conhecimento"}, {en: "Goal", pt: "Objetivo"}] },
            intermediate: { label_key: "inter", cost: 250, cards: [{en: "Worth it", pt: "Vale a pena"}, {en: "Ambiguous", pt: "Amb√≠guo"}] },
            advanced: { 
                label_key: "adv", 
                cost: 600, 
                cards: [
                    {en: "Eloquent", pt: "Eloquente"}, 
                    {en: "Nevertheless", pt: "Todavia"},
                    {en: "Paradigm shift", pt: "Mudan√ßa de paradigma"}
                ] 
            }
        };

        let state = {
            user: null,
            gems: 0,
            xp: 0,
            streak: 0,
            lastLoginDate: null,
            unlocked: ['basic'],
            level: 'basic',
            view: 'home',
            theme: 'theme-blue',
            bgStyle: 'bg-style-default',
            lang: 'pt',
            cardIdx: 0,
            chatMessages: [],
            grammarAnalysis: null,
            leaderboard: []
        };

        const db = window.db;
        const auth = window.auth;

        function updateStreakLogic() {
            const today = new Date().toISOString().split('T')[0];
            if (!state.lastLoginDate) {
                state.streak = 1;
            } else {
                const lastDate = new Date(state.lastLoginDate);
                const currDate = new Date(today);
                const diffTime = Math.abs(currDate - lastDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                if (diffDays === 1) state.streak += 1;
                else if (diffDays > 1) state.streak = 1;
            }
            state.lastLoginDate = today;
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                state.user = user;
                document.getElementById('auth-screen').classList.add('hidden');
                document.getElementById('main-ui').classList.remove('hidden');
                syncUserData(user.uid);
                syncLeaderboard();
                changeView(state.view);
            } else {
                document.getElementById('auth-screen').classList.remove('hidden');
                document.getElementById('main-ui').classList.add('hidden');
            }
        });

        async function syncUserData(uid) {
            const userDocRef = doc(db, 'artifacts', window.appId, 'users', uid, 'profile', 'data');
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    state.gems = data.gems || 0;
                    state.unlocked = data.unlocked || ['basic'];
                    state.xp = data.xp || 0;
                    state.streak = data.streak || 0;
                    state.lastLoginDate = data.lastLoginDate || null;
                    state.theme = data.theme || 'theme-blue';
                    state.bgStyle = data.bgStyle || 'bg-style-default';
                    state.lang = data.lang || 'pt';
                    if (!window.streakUpdated) {
                        updateStreakLogic();
                        window.streakUpdated = true;
                        saveData();
                    }
                    applyTheme(state.theme);
                    applyBackground(state.bgStyle);
                    updateUI();
                } else { saveData(); }
            });
        }

        async function saveData() {
            if (!state.user) return;
            const uid = state.user.uid;
            const userDocRef = doc(db, 'artifacts', window.appId, 'users', uid, 'profile', 'data');
            await setDoc(userDocRef, {
                gems: state.gems, unlocked: state.unlocked, xp: state.xp, streak: state.streak, 
                lastLoginDate: state.lastLoginDate, theme: state.theme, bgStyle: state.bgStyle, lang: state.lang, updatedAt: new Date().toISOString()
            }, { merge: true });
            const leaderboardDocRef = doc(db, 'artifacts', window.appId, 'public', 'data', 'leaderboard', uid);
            await setDoc(leaderboardDocRef, { displayName: state.user.displayName || 'Utilizador Legacy', xp: state.xp, updatedAt: new Date().toISOString() }, { merge: true });
        }

        function syncLeaderboard() {
            const leaderboardCol = collection(db, 'artifacts', window.appId, 'public', 'data', 'leaderboard');
            onSnapshot(leaderboardCol, (snapshot) => {
                const data = [];
                snapshot.forEach(doc => data.push({ id: doc.id, ...doc.data() }));
                state.leaderboard = data.sort((a, b) => b.xp - a.xp);
                if (state.view === 'ranking') renderRanking(document.getElementById('app-viewport'), I18N[state.lang]);
            });
        }

        window.speakText = (text) => {
            if (!window.speechSynthesis) return;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            utterance.rate = 0.9;
            window.speechSynthesis.speak(utterance);
        };

        function applyTheme(t) {
            document.body.classList.remove('theme-blue', 'theme-emerald', 'theme-rose', 'theme-slate');
            document.body.classList.add(t);
            state.theme = t;
        }

        function applyBackground(bg) {
            document.body.classList.remove('bg-style-default', 'bg-style-cream', 'bg-style-dark', 'bg-style-gradient-sky', 'bg-style-gradient-sunset');
            document.body.classList.add(bg);
            state.bgStyle = bg;
        }

        window.changeView = (view) => {
            state.view = view;
            const viewport = document.getElementById('app-viewport');
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.remove('nav-active');
                b.classList.add('text-slate-400');
            });
            const activeNav = document.getElementById(view === 'tutor' ? 'nav-tutor-btn' : (view === 'grammar' ? 'nav-grammar' : `nav-${view}`));
            if (activeNav) {
                activeNav.classList.add('nav-active');
                activeNav.classList.remove('text-slate-400');
            }
            viewport.innerHTML = '';
            const s = I18N[state.lang];
            switch(view) {
                case 'home': renderHome(viewport, s); break;
                case 'flashcards': renderFlashcards(viewport, s); break;
                case 'tutor': renderTutor(viewport, s); break;
                case 'grammar': renderGrammar(viewport, s); break;
                case 'ranking': renderRanking(viewport, s); break;
                case 'settings': renderSettings(viewport, s); break;
            }
        };

        function renderHome(container, s) {
            container.innerHTML = `
                <div class="view-animate text-center sm:text-left">
                    <div class="bg-primary rounded-[2.5rem] p-8 text-white shadow-xl mb-8 flex justify-between items-center overflow-hidden relative">
                        <div class="z-10">
                            <h2 class="text-2xl font-bold mb-1 italic">${s.welcome}!</h2>
                            <p class="text-white/70 text-[10px] uppercase font-bold tracking-widest">${s.level}: ${s[GAME_DATA[state.level].label_key]}</p>
                            <div class="mt-4 flex gap-2">
                                <div class="bg-white/20 px-3 py-1 rounded-full text-[9px] font-bold">XP: ${state.xp}</div>
                                <div class="bg-white/20 px-3 py-1 rounded-full text-[9px] font-bold">üî• ${state.streak} dias</div>
                            </div>
                        </div>
                        <div class="text-6xl opacity-20 absolute -right-4 -bottom-4">üåü</div>
                    </div>
                    <div class="space-y-3">
                        ${Object.keys(GAME_DATA).map(lvl => `
                            <button onclick="setLevel('${lvl}')" class="w-full flex items-center justify-between p-6 rounded-3xl border-2 ${state.level === lvl ? 'border-primary bg-primary-light' : 'bg-white border-slate-100'} transition-all active:scale-95 shadow-sm group">
                                <span class="font-bold text-slate-700 uppercase text-xs tracking-widest group-hover:text-primary transition-colors">${s[GAME_DATA[lvl].label_key]}</span>
                                <span class="text-xs text-slate-500">${state.unlocked.includes(lvl) ? '‚úÖ' : 'üîí üíé' + GAME_DATA[lvl].cost}</span>
                            </button>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        function renderFlashcards(container, s) {
            const card = GAME_DATA[state.level].cards[state.cardIdx];
            container.innerHTML = `
                <div class="view-animate text-center">
                    <div class="card-container mb-8" onclick="flipFlashcard(this, '${card.en}')">
                        <div class="card-inner">
                            <div class="card-face card-front relative border-4 border-primary/20">
                                <button onclick="event.stopPropagation(); speakText('${card.en}')" class="absolute top-4 right-4 bg-slate-100 p-3 rounded-2xl text-xl hover:bg-primary hover:text-white transition-all shadow-sm">üîä</button>
                                <div class="text-[10px] uppercase font-bold text-slate-400 mb-4 tracking-widest">Ingl√™s</div>
                                <h3 class="text-4xl font-black text-primary">${card.en}</h3>
                                <p class="text-slate-400 mt-12 italic text-[10px] font-bold uppercase tracking-widest">Toca para traduzir</p>
                            </div>
                            <div class="card-face card-back border-4 border-white/20 shadow-inner">
                                <div class="text-[10px] uppercase font-bold text-white/50 mb-4 tracking-widest">Portugu√™s</div>
                                <h3 class="text-3xl font-bold">${card.pt}</h3>
                                <div id="ai-example" class="mt-6 text-[11px] opacity-90 italic px-4 font-medium text-white/80 leading-relaxed bg-black/10 py-3 rounded-2xl"></div>
                            </div>
                        </div>
                    </div>
                    <div class="flex space-x-3">
                        <button onclick="navCard(-1)" class="flex-1 py-4 bg-white border-2 border-slate-100 rounded-2xl font-bold text-slate-400 shadow-sm">${s.prev}</button>
                        <button onclick="navCard(1)" class="flex-1 py-4 bg-primary text-white rounded-2xl font-bold shadow-lg active:scale-95">${s.next}</button>
                    </div>
                </div>
            `;
        }

        window.flipFlashcard = (el, englishText) => {
            const inner = el.querySelector('.card-inner');
            const isFlippingToBack = !inner.classList.contains('is-flipped');
            inner.classList.toggle('is-flipped');
            if (isFlippingToBack) setTimeout(() => speakText(englishText), 100);
        };

        function renderGrammar(container, s) {
            container.innerHTML = `
                <div class="view-animate">
                    <h2 class="text-2xl font-black mb-4 tracking-tight">${s.grammar}</h2>
                    <div class="bg-white p-4 rounded-3xl shadow-sm border border-slate-100 mb-4">
                        <textarea id="grammar-input" placeholder="${s.placeholder_grammar}" class="w-full h-40 bg-transparent resize-none outline-none text-sm leading-relaxed"></textarea>
                    </div>
                    <button onclick="analyzeGrammar()" id="grammar-btn" class="w-full py-4 bg-primary text-white rounded-2xl font-bold shadow-lg active:scale-95 flex items-center justify-center space-x-2">
                        <span id="grammar-btn-text">‚úçÔ∏è ${s.analyze}</span>
                        <div id="grammar-loader" class="ai-loading border-t-white hidden"></div>
                    </button>
                    <div id="grammar-result" class="mt-6 ${state.grammarAnalysis ? '' : 'hidden'} pb-10">
                        ${state.grammarAnalysis ? `<div class="bg-white p-6 rounded-3xl border border-slate-100 shadow-sm text-sm chat-bubble bubble-bot w-full">${state.grammarAnalysis}</div>` : ''}
                    </div>
                </div>
            `;
        }

        window.analyzeGrammar = async () => {
            const input = document.getElementById('grammar-input');
            const btnText = document.getElementById('grammar-btn-text');
            const loader = document.getElementById('grammar-loader');
            const s = I18N[state.lang];
            if (!input.value.trim()) return;
            loader.classList.remove('hidden');
            btnText.innerText = s.analyzing;
            const prompt = `Analisa e corrige este texto em ingl√™s: "${input.value.trim()}". Estrutura por pontos em Portugu√™s.`;
            state.grammarAnalysis = await callGemini(prompt, "Especialista em Gram√°tica Legacy.");
            renderGrammar(document.getElementById('app-viewport'), s);
        };

        async function callGemini(prompt, systemMsg = "") {
            const url = `https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${apiKey}`;
            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{ parts: [{ text: prompt }] }],
                        systemInstruction: { parts: [{ text: "Tutor profissional LingoQuest. Responde em Portugu√™s de forma organizada. " + systemMsg }] }
                    })
                });
                const result = await response.json();
                return result.candidates?.[0]?.content?.parts?.[0]?.text || "Erro na IA.";
            } catch (e) { return "Erro de liga√ß√£o."; }
        }

        function renderRanking(container, s) {
            container.innerHTML = `
                <div class="view-animate">
                    <h2 class="text-2xl font-black mb-6 tracking-tight">${s.ranking} Global</h2>
                    <div class="space-y-3">
                        ${state.leaderboard.map((u, i) => {
                            let badge = i + 1; let bClass = "bg-slate-100";
                            if(i===0) { badge="ü•á"; bClass="rank-gold"; }
                            else if(i===1) { badge="ü•à"; bClass="rank-silver"; }
                            else if(i===2) { badge="ü•â"; bClass="rank-bronze"; }
                            return `
                                <div class="flex items-center justify-between p-5 rounded-3xl border-2 ${u.id === state.user?.uid ? 'bg-primary text-white border-primary shadow-lg scale-[1.02]' : 'bg-white border-slate-50'} transition-all">
                                    <div class="flex items-center">
                                        <div class="w-10 h-10 rounded-2xl flex items-center justify-center font-black mr-4 ${bClass}">${badge}</div>
                                        <div class="font-bold text-sm">${u.displayName}</div>
                                    </div>
                                    <div class="font-black text-xs">XP ${u.xp}</div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderTutor(container, s) {
            container.innerHTML = `
                <div class="view-animate flex flex-col h-full">
                    <div id="chat-win" class="flex-1 overflow-y-auto space-y-4 p-4 bg-white/50 rounded-[2.5rem] border border-slate-100 min-h-[400px]">
                        ${state.chatMessages.map(m => `<div class="flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}"><div class="chat-bubble ${m.role === 'user' ? 'bubble-user' : 'bubble-bot'} shadow-sm">${m.text}</div></div>`).join('') || '<p class="text-center py-20 text-slate-400">Conversa comigo em Ingl√™s!</p>'}
                    </div>
                    <div class="flex mt-4 space-x-2 bg-white p-2 rounded-3xl shadow-sm border border-slate-100">
                        <input id="chat-in" type="text" placeholder="Type here..." class="flex-1 p-3 px-4 outline-none text-sm bg-transparent">
                        <button onclick="sendChat()" class="p-3 px-5 bg-primary text-white rounded-2xl font-bold shadow-lg">‚ö°</button>
                    </div>
                </div>
            `;
            const w = document.getElementById('chat-win'); w.scrollTop = w.scrollHeight;
        }

        window.sendChat = async () => {
            const i = document.getElementById('chat-in');
            const txt = i.value.trim();
            if(!txt) return;
            state.chatMessages.push({role: 'user', text: txt});
            i.value = ''; renderTutor(document.getElementById('app-viewport'), I18N[state.lang]);
            const res = await callGemini(txt, `Tutor Legacy. Conversa amig√°vel.`);
            state.chatMessages.push({role: 'bot', text: res});
            renderTutor(document.getElementById('app-viewport'), I18N[state.lang]);
        };

        function renderSettings(container, s) {
            container.innerHTML = `
                <div class="view-animate space-y-6">
                    <h2 class="text-2xl font-black tracking-tight">${s.settings}</h2>
                    
                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">Cor de Destaque</p>
                        <div class="grid grid-cols-4 gap-3">
                            ${['blue','emerald','rose','slate'].map(c => `<button onclick="updateTheme('theme-${c}')" class="h-14 bg-${c==='blue'?'sky':(c==='emerald'?'emerald':(c==='rose'?'rose':'slate'))}-500 rounded-2xl active:scale-95 transition-all shadow-md border-4 ${state.theme === 'theme-'+c ? 'border-white ring-2 ring-slate-200' : 'border-white'}"></button>`).join('')}
                        </div>
                    </div>

                    <div>
                        <p class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">${s.bg_style}</p>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-3">
                            <button onclick="updateBackground('bg-style-default')" class="p-4 bg-slate-50 border-2 rounded-2xl font-bold text-sm ${state.bgStyle === 'bg-style-default' ? 'border-primary' : 'border-slate-200'}">Padr√£o</button>
                            <button onclick="updateBackground('bg-style-cream')" class="p-4 bg-amber-50 border-2 rounded-2xl font-bold text-sm ${state.bgStyle === 'bg-style-cream' ? 'border-primary' : 'border-slate-200'}">Leitura (Creme)</button>
                            <button onclick="updateBackground('bg-style-dark')" class="p-4 bg-slate-900 text-white border-2 rounded-2xl font-bold text-sm ${state.bgStyle === 'bg-style-dark' ? 'border-primary' : 'border-slate-200'}">Noite (Dark)</button>
                            <button onclick="updateBackground('bg-style-gradient-sky')" class="p-4 bg-gradient-to-br from-sky-100 to-white border-2 rounded-2xl font-bold text-sm ${state.bgStyle === 'bg-style-gradient-sky' ? 'border-primary' : 'border-slate-200'}">C√©u Suave</button>
                        </div>
                    </div>

                    <div class="space-y-3 pt-6 pb-8 text-center sm:text-left">
                        <button onclick="handleReset()" class="w-full py-4 bg-rose-50 text-rose-600 rounded-2xl font-bold border border-rose-100 text-sm shadow-sm active:scale-95 transition-all">${s.reset}</button>
                        <button onclick="window.signOut(window.auth)" class="w-full py-4 bg-white text-slate-400 rounded-2xl font-bold border border-slate-100 text-sm shadow-sm active:scale-95 transition-all">Sair da Conta</button>
                    </div>
                </div>
            `;
        }

        window.setLevel = async (lvl) => {
            if (state.unlocked.includes(lvl)) { state.level = lvl; saveData(); changeView('home'); }
            else {
                const cost = GAME_DATA[lvl].cost;
                if(state.gems >= cost) { state.gems -= cost; state.unlocked.push(lvl); await saveData(); setLevel(lvl); }
                else alert("Gemas insuficientes!");
            }
        };
        window.handleReset = async () => { if(confirm("Apagar tudo?")) { state.gems=0; state.xp=0; state.streak=0; state.unlocked=['basic']; state.level='basic'; await saveData(); changeView('home'); } };
        window.updateTheme = (t) => { state.theme = t; applyTheme(t); saveData(); changeView('settings'); };
        window.updateBackground = (bg) => { state.bgStyle = bg; applyBackground(bg); saveData(); changeView('settings'); };
        window.navCard = (dir) => { const l=GAME_DATA[state.level].cards.length; state.cardIdx=(state.cardIdx+dir+l)%l; renderFlashcards(document.getElementById('app-viewport'), I18N[state.lang]); };
        
        function updateUI() {
            const g = document.getElementById('ui-gems-count'); const t = document.getElementById('ui-current-lvl-tag'); const s = document.getElementById('ui-streak-count');
            if(g) g.textContent = state.gems;
            if(t) t.textContent = I18N[state.lang][GAME_DATA[state.level].label_key];
            if(s) s.textContent = state.streak;
            updateUIStrings();
        }

        function updateUIStrings() {
            const s = I18N[state.lang];
            const ids = ['nav-txt-home', 'nav-txt-study', 'nav-txt-tutor', 'nav-txt-grammar', 'nav-txt-ranking'];
            const keys = ['home', 'study', 'tutor', 'grammar', 'ranking'];
            ids.forEach((id, i) => { const el = document.getElementById(id); if(el) el.textContent = s[keys[i]]; });
        }

        window.loginAnonymously = async () => { try { await window.signInAnonymously(window.auth); } catch(e){} };

        window.onload = () => changeView('home');
    </script>
</body>
</html>