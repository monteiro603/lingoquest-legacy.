import React, { useState, useEffect, useRef } from 'react';
import { initializeApp } from 'firebase/app';
import { 
  getAuth, 
  onAuthStateChanged, 
  signInWithCustomToken, 
  signInAnonymously,
  signInWithPopup,
  GoogleAuthProvider,
  signOut
} from 'firebase/auth';
import { 
  getFirestore, 
  collection, 
  onSnapshot, 
  addDoc, 
  query,
  doc,
  setDoc,
  getDoc,
  updateDoc,
  serverTimestamp 
} from 'firebase/firestore';

// --- Configura√ß√£o Firebase ---
const firebaseConfig = JSON.parse(__firebase_config);
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const appId = typeof __app_id !== 'undefined' ? __app_id : 'lingoquest-pro-v2';

// --- Configura√ß√£o Gemini API ---
const apiKey = ""; 
const GEMINI_MODEL = "gemini-2.5-flash-preview-09-2025";
const TTS_MODEL = "gemini-2.5-flash-preview-tts";

// --- IDs REAIS DO ADMOB ---
const ADS_CONFIG = {
  banner: "ca-app-pub-9320700800755219/5931552671",
  rewarded: "ca-app-pub-9320700800755219/4119777558"
};

const BannerAdSize = { BANNER: 'BANNER' };
const BannerAdPosition = { BOTTOM_CENTER: 'BOTTOM_CENTER' };

// --- Fun√ß√£o Utilit√°ria: √Åudio PCM para WAV ---
function pcmToWav(pcmBase64, sampleRate = 24000) {
  const binaryString = atob(pcmBase64);
  const len = binaryString.length;
  const bytes = new Uint8Array(len);
  for (let i = 0; i < len; i++) {
    bytes[i] = binaryString.charCodeAt(i);
  }
  const buffer = new ArrayBuffer(44 + bytes.length);
  const view = new DataView(buffer);
  const writeString = (offset, string) => {
    for (let i = 0; i < string.length; i++) {
      view.setUint8(offset + i, string.charCodeAt(i));
    }
  };
  writeString(0, 'RIFF');
  view.setUint32(4, 36 + bytes.length, true);
  writeString(8, 'WAVE');
  writeString(12, 'fmt ');
  view.setUint32(16, 16, true);
  view.setUint16(20, 1, true);
  view.setUint16(22, 1, true);
  view.setUint32(24, sampleRate, true);
  view.setUint32(28, sampleRate * 2, true);
  view.setUint16(32, 2, true);
  view.setUint16(34, 16, true);
  writeString(36, 'data');
  view.setUint32(40, bytes.length, true);
  const pcmPayload = new Uint8Array(buffer, 44);
  pcmPayload.set(bytes);
  const blob = new Blob([buffer], { type: 'audio/wav' });
  return URL.createObjectURL(blob);
}

export default function App() {
  const [user, setUser] = useState(null);
  const [loading, setLoading] = useState(true);
  const [view, setView] = useState('login'); 
  const [messages, setMessages] = useState([]);
  const [leaderboard, setLeaderboard] = useState([]);
  const [input, setInput] = useState('');
  const [aiLoading, setAiLoading] = useState(false);
  const [showModal, setShowModal] = useState(null); 
  const [isSpeaking, setIsSpeaking] = useState(false);
  
  // Cores: emerald, white, black, pink, red
  const [accentColor, setAccentColor] = useState('emerald'); 

  const [userData, setUserData] = useState({
    gems: 100, xp: 0, streak: 1, level: 'basic', isPremium: false, unlockedLevels: ['basic'], name: 'Estudante'
  });

  const [quizState, setQuizState] = useState({
    active: false, currentIdx: 0, score: 0,
    questions: [
      { q: "Como se diz 'Ol√°' em Ingl√™s?", a: ["Hello", "Bread", "Blue", "Man"], c: 0 },
      { q: "O que significa 'Bread'?", a: ["√Ågua", "P√£o", "Caf√©", "Casa"], c: 1 },
      { q: "Qual a cor do c√©u (Sky)?", a: ["Red", "Green", "Blue", "Black"], c: 2 },
      { q: "I ___ a student.", a: ["is", "am", "are", "be"], c: 1 }
    ]
  });

  const messagesEndRef = useRef(null);

  const colorMap = {
    emerald: { bg: 'bg-emerald-500', text: 'text-emerald-500', border: 'border-emerald-500', shadow: 'shadow-emerald-500/20', name: 'Verde' },
    white: { bg: 'bg-slate-100', text: 'text-slate-100', border: 'border-slate-100', shadow: 'shadow-slate-100/20', name: 'Branco' },
    black: { bg: 'bg-slate-900', text: 'text-slate-900', border: 'border-slate-900', shadow: 'shadow-slate-900/20', name: 'Preto' },
    pink: { bg: 'bg-pink-500', text: 'text-pink-500', border: 'border-pink-500', shadow: 'shadow-pink-500/20', name: 'Rosa' },
    red: { bg: 'bg-red-600', text: 'text-red-600', border: 'border-red-600', shadow: 'shadow-red-600/20', name: 'Vermelho' }
  };

  const currentTheme = colorMap[accentColor] || colorMap.emerald;

  // --- TTS LOGIC ---
  const speakText = async (textToSpeak) => {
    if (!textToSpeak || isSpeaking) return;
    setIsSpeaking(true);
    try {
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${TTS_MODEL}:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{ parts: [{ text: `Say clearly: ${textToSpeak}` }] }],
          generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } },
          model: TTS_MODEL
        })
      });
      const result = await res.json();
      const pcmData = result.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;
      if (pcmData) {
        const audio = new Audio(pcmToWav(pcmData));
        audio.onended = () => setIsSpeaking(false);
        audio.play();
      } else { setIsSpeaking(false); }
    } catch (e) { setIsSpeaking(false); }
  };

  useEffect(() => {
    if (view === 'quiz' && quizState.active) {
      speakText(quizState.questions[quizState.currentIdx].q);
    }
  }, [view, quizState.currentIdx, quizState.active]);

  // --- RULE 3: AUTH FIRST ---
  useEffect(() => {
    const initAuth = async () => {
      try {
        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
          await signInWithCustomToken(auth, __initial_auth_token);
        } else {
          await signInAnonymously(auth);
        }
      } catch (err) {
        console.error("Auth init error:", err);
      }
    };
    initAuth();

    const unsubscribe = onAuthStateChanged(auth, (u) => { 
      setUser(u); 
      setLoading(false);
      if (u) setView('home');
      else setView('login');
    });
    return () => unsubscribe();
  }, []);

  // --- RULE 1 & 2: LISTENERS WITH GUARD AND MEMORY SORT ---
  useEffect(() => {
    if (!user) return; // Guard every firestore operation

    // Public Data: Leaderboard
    const rankCol = collection(db, 'artifacts', appId, 'public', 'data', 'leaderboard');
    const unsubRank = onSnapshot(query(rankCol), (snap) => {
      const list = snap.docs.map(d => d.data());
      // RULE 2: Filter/Sort in memory
      setLeaderboard(list.sort((a, b) => (b.xp || 0) - (a.xp || 0)).slice(0, 10));
    }, (err) => console.error("Leaderboard Error:", err));

    // Private Data: Profile
    const userRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data');
    const unsubProfile = onSnapshot(userRef, (docSnap) => {
      if (docSnap.exists()) {
        setUserData(docSnap.data());
      } else {
        const initial = { 
          gems: 100, xp: 0, streak: 1, level: 'basic', isPremium: false, 
          unlockedLevels: ['basic'], name: user.displayName || `Aluno_${user.uid.slice(0,4)}` 
        };
        setDoc(userRef, initial).catch(e => console.error("Profile set error:", e));
      }
    }, (err) => console.error("Profile Error:", err));

    // Public Data: Tutor Messages
    const msgCol = collection(db, 'artifacts', appId, 'public', 'data', 'messages');
    const unsubMsgs = onSnapshot(query(msgCol), (snap) => {
      const list = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      // RULE 2: Sort in memory
      setMessages(list.sort((a, b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0)));
    }, (err) => console.error("Chat Error:", err));

    return () => { unsubRank(); unsubProfile(); unsubMsgs(); };
  }, [user]);

  // --- ADMOB ---
  useEffect(() => {
    const initAds = async () => {
      try {
        const { AdMob } = await import('@capacitor-community/admob').catch(() => ({ AdMob: null }));
        if (AdMob && user && !userData.isPremium) {
          await AdMob.initialize();
          await AdMob.showBanner({ 
            adId: ADS_CONFIG.banner, 
            adSize: BannerAdSize.BANNER, 
            position: BannerAdPosition.BOTTOM_CENTER, 
            isTesting: false 
          });
        }
      } catch (e) {}
    };
    initAds();
    return () => {
      const hideBanner = async () => {
        try {
          const { AdMob } = await import('@capacitor-community/admob').catch(() => ({ AdMob: null }));
          if (AdMob) await AdMob.hideBanner();
        } catch (e) {}
      };
      hideBanner();
    };
  }, [user, userData.isPremium]);

  // --- ACTIONS ---
  const handleLogout = async () => {
    try {
      const { AdMob } = await import('@capacitor-community/admob').catch(() => ({ AdMob: null }));
      if (AdMob) await AdMob.hideBanner();
    } catch (e) {}
    await signOut(auth);
    setUser(null);
  };

  const loginWithGoogle = () => signInWithPopup(auth, new GoogleAuthProvider());
  const loginAsGuest = () => signInAnonymously(auth);

  const updateXP = async (xpGain, gemGain = 0) => {
    if (!user) return;
    const up = { xp: (userData.xp || 0) + xpGain, gems: (userData.gems || 0) + gemGain };
    setUserData(p => ({ ...p, ...up }));
    
    try {
      const userRef = doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data');
      const rankRef = doc(db, 'artifacts', appId, 'public', 'data', 'leaderboard', user.uid);
      await updateDoc(userRef, up);
      await setDoc(rankRef, { name: userData.name, xp: up.xp, uid: user.uid, isPremium: userData.isPremium });
    } catch (e) { console.error("XP Update error:", e); }
  };

  const handleLevelSelection = async (lvl) => {
    const costs = { basic: 0, intermediate: 200, advanced_tech: 500 };
    if (userData.isPremium || userData.unlockedLevels.includes(lvl)) {
      setUserData(p => ({ ...p, level: lvl }));
      setView('tutor');
    } else if (userData.gems >= costs[lvl]) {
      const up = { gems: (userData.gems || 0) - costs[lvl], unlockedLevels: [...userData.unlockedLevels, lvl], level: lvl };
      setUserData(p => ({ ...p, ...up }));
      if (user) {
        await updateDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'profile', 'data'), up);
      }
      setView('tutor');
    } else { setView('store'); }
  };

  const handleRewardedAd = async () => {
    if (!user) return;
    try {
      const { AdMob } = await import('@capacitor-community/admob').catch(() => ({ AdMob: null }));
      if (AdMob) {
        await AdMob.prepareRewardVideoAd({ adId: ADS_CONFIG.rewarded, ssv: { userId: user.uid } });
        const reward = await AdMob.showRewardVideoAd();
        if (reward && reward.type) {
          updateXP(0, 50);
          alert("Recebeste 50 gemas! üíé");
        }
      } else {
        setAiLoading(true); 
        setTimeout(() => { updateXP(0, 50); setAiLoading(false); alert("Simula√ß√£o: 50 gemas recebidas! üíé"); }, 2000); 
      }
    } catch (e) { alert("An√∫ncio indispon√≠vel."); }
  };

  const answerQuiz = (idx) => {
    const correct = idx === quizState.questions[quizState.currentIdx].c;
    const next = quizState.currentIdx + 1;
    const score = correct ? quizState.score + 1 : quizState.score;
    if (next < quizState.questions.length) setQuizState(p => ({ ...p, currentIdx: next, score }));
    else { updateXP(score * 25); setView('home'); alert(`Quiz terminado! Acertaste ${score}/${quizState.questions.length}!`); }
  };

  const sendTutorMsg = async (e) => {
    e.preventDefault();
    if (!input.trim() || aiLoading || !user) return;
    const txt = input; setInput('');
    const msgCol = collection(db, 'artifacts', appId, 'public', 'data', 'messages');
    try {
      await addDoc(msgCol, { text: txt, userId: user.uid, username: userData.name, timestamp: serverTimestamp() });
      setAiLoading(true);
      const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: txt }] }], systemInstruction: { parts: [{ text: `Tutor LingoQuest Pro. N√≠vel ${userData.level}. Responde em Ingl√™s com tradu√ß√£o breve.` }] } })
      });
      const data = await res.json();
      const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text || "Erro na resposta.";
      await addDoc(msgCol, { text: aiText, userId: 'ai', username: 'Tutor Gemini ‚ú®', timestamp: serverTimestamp(), isAi: true });
    } catch (e) {} finally { setAiLoading(false); }
  };

  if (loading) return <div className="h-screen bg-[#020617] flex items-center justify-center text-sky-500 font-black animate-pulse">LingoQuest Pro...</div>;

  if (view === 'login' || !user) return (
    <div className="h-screen bg-[#020617] flex flex-col items-center justify-center p-6 space-y-8 text-center">
      <div className={`${colorMap.emerald.bg} w-20 h-20 rounded-3xl flex items-center justify-center text-slate-900 text-3xl font-black shadow-2xl`}>LQ</div>
      <h1 className="text-3xl font-black text-white italic tracking-tighter uppercase">LingoQuest <span className={colorMap.emerald.text}>Pro</span></h1>
      <div className="w-full max-w-xs space-y-3">
        <button onClick={loginWithGoogle} className="w-full py-4 bg-white text-slate-950 rounded-2xl font-black text-sm shadow-xl">Google Login</button>
        <button onClick={loginAsGuest} className="w-full py-4 bg-slate-800 text-slate-300 rounded-2xl font-black text-sm border border-white/5">Modo Convidado</button>
      </div>
    </div>
  );

  return (
    <div className="min-h-screen bg-[#020617] text-white font-sans flex flex-col items-center transition-all duration-300">
      <div className="w-full max-w-2xl flex flex-col min-h-screen relative border-x border-white/5 shadow-2xl overflow-hidden">
        
        {/* Header */}
        <header className="p-4 sticky top-0 z-50 flex justify-between items-center backdrop-blur-md border-b bg-slate-950/80 border-white/5">
          <div className="flex items-center gap-3">
            <div onClick={() => setView('home')} className={`${currentTheme.bg} w-8 h-8 rounded-lg flex items-center justify-center text-slate-950 font-black text-[10px] cursor-pointer shadow-lg`}>LQ</div>
            <button onClick={() => setView('settings')} className={`p-2 rounded-lg transition-colors hover:bg-white/10 ${view === 'settings' ? currentTheme.text : 'text-slate-400'}`}>
              <i className="fas fa-cog text-sm"></i>
            </button>
          </div>
          <div className="flex items-center gap-2">
            <div onClick={() => setView('ranking')} className="bg-emerald-500/10 px-3 py-1.5 rounded-xl text-emerald-500 font-black text-[10px] cursor-pointer hover:bg-emerald-500/20">üèÜ Rank</div>
            <div onClick={() => setView('store')} className="bg-amber-500/10 px-3 py-1.5 rounded-xl text-amber-500 font-black text-[10px] cursor-pointer hover:bg-amber-500/20">üíé {userData.gems || 0}</div>
          </div>
        </header>

        <main className="flex-1 p-6 pb-40">
          {view === 'home' && (
            <div className="space-y-6 animate-in slide-up">
              <div className="bg-gradient-to-br from-slate-800 to-slate-950 p-8 rounded-[2.5rem] shadow-xl border border-white/5">
                <p className="text-[10px] font-black uppercase tracking-widest opacity-60">N√≠vel Atual</p>
                <h2 className={`text-3xl font-black italic uppercase tracking-tighter mb-4 ${currentTheme.text}`}>{userData.level}</h2>
                <div className="flex items-center gap-4">
                  <div className="flex-1 h-2 bg-black/30 rounded-full overflow-hidden">
                    <div className={`h-full ${currentTheme.bg} transition-all duration-700`} style={{ width: `${(userData.xp || 0) % 100}%` }}></div>
                  </div>
                  <span className={`text-xs font-black ${currentTheme.text}`}>{userData.xp || 0} XP</span>
                </div>
              </div>

              <button onClick={() => { setQuizState(p => ({...p, active: true, currentIdx: 0, score: 0})); setView('quiz'); }} className="w-full p-6 bg-slate-900 border border-white/5 rounded-3xl flex items-center justify-between active:scale-95 transition-all">
                <div className="text-left">
                  <h3 className={`font-black italic text-sm ${currentTheme.text}`}>Desafio Quiz üå±</h3>
                  <p className="text-[9px] text-slate-500 font-bold uppercase tracking-wider">Ganha XP Extra</p>
                </div>
                <div className={`w-10 h-10 ${currentTheme.bg} rounded-2xl flex items-center justify-center text-slate-900 shadow-lg`}><i className="fas fa-play ml-1"></i></div>
              </button>

              <div className="grid grid-cols-1 gap-4">
                {[{id:'basic', l:'Iniciante', i:'üå±'}, {id:'intermediate', l:'Interm√©dio', i:'üöÄ'}, {id:'advanced_tech', l:'Avan√ßado', i:'‚öì'}].map(l => (
                  <button key={l.id} onClick={() => handleLevelSelection(l.id)} className={`p-6 bg-slate-900 border border-white/5 rounded-3xl text-left flex items-center gap-6 active:scale-95 transition-all ${!userData.unlockedLevels.includes(l.id) && !userData.isPremium ? 'opacity-40 grayscale' : ''}`}>
                    <div className="text-3xl">{l.i}</div>
                    <div className="flex-1">
                      <h4 className="font-black uppercase text-xs tracking-widest">{l.l}</h4>
                      {!userData.unlockedLevels.includes(l.id) && !userData.isPremium && <p className="text-[8px] text-amber-500 font-black uppercase italic mt-1 tracking-wider">Trancado</p>}
                    </div>
                  </button>
                ))}
              </div>
            </div>
          )}

          {view === 'quiz' && (
            <div className="space-y-8 animate-in fade-in py-10 text-center">
              {isSpeaking && <div className={`${currentTheme.text} text-[10px] font-black uppercase animate-pulse mb-4`}><i className="fas fa-volume-up mr-2"></i>A Falar...</div>}
              <h2 className="text-2xl font-black italic">{quizState.questions[quizState.currentIdx].q}</h2>
              <div className="grid grid-cols-1 gap-3 mt-10">
                {quizState.questions[quizState.currentIdx].a.map((opt, i) => (
                  <button key={i} onClick={() => answerQuiz(i)} className={`p-5 bg-slate-900 border border-white/5 rounded-2xl font-bold text-sm text-left hover:bg-emerald-600 active:scale-95 shadow-md`}>{opt}</button>
                ))}
              </div>
            </div>
          )}

          {view === 'ranking' && (
            <div className="space-y-6 animate-in slide-up">
              <h2 className="text-2xl font-black italic text-center uppercase tracking-tighter">Ranking Global üèÜ</h2>
              <div className="rounded-[2rem] border border-white/5 overflow-hidden bg-slate-900/50 shadow-2xl">
                {leaderboard.length === 0 && <div className="p-10 text-center opacity-30 text-[10px] font-black">A carregar...</div>}
                {leaderboard.map((u, i) => (
                  <div key={i} className={`p-5 flex items-center justify-between border-b border-white/5 ${u.uid === (user?.uid) ? 'bg-emerald-500/10' : ''}`}>
                    <div className="flex items-center gap-4">
                      <span className={`text-xs font-black ${i < 3 ? 'text-amber-500' : 'text-slate-500'}`}>{i + 1}</span>
                      <div className="text-xs font-bold">{u.name} {u.isPremium && '‚ú®'}</div>
                    </div>
                    <div className={`text-[10px] font-black uppercase ${currentTheme.text}`}>{String(u.xp || 0)} XP</div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {view === 'tutor' && (
            <div className="flex flex-col h-[70vh] rounded-[2.5rem] border border-white/5 bg-slate-900/30 overflow-hidden p-2 shadow-2xl">
              <div className="flex-1 overflow-y-auto space-y-4 p-4 scrollbar-hide">
                {messages.map(m => (
                  <div key={m.id} className={`flex ${m.userId === (user?.uid) ? 'justify-end' : 'justify-start'}`}>
                    <div className={`max-w-[85%] p-4 rounded-3xl text-xs leading-relaxed ${m.userId === (user?.uid) ? `${currentTheme.bg} text-slate-900 font-bold rounded-tr-none shadow-lg` : 'bg-slate-800 text-slate-200 rounded-tl-none border border-white/5'}`}>
                      {m.text}
                    </div>
                  </div>
                ))}
                {aiLoading && <div className={`${currentTheme.text} text-[9px] font-black uppercase animate-pulse tracking-widest`}>Tutor a pensar...</div>}
                <div ref={messagesEndRef} />
              </div>
              <form onSubmit={sendTutorMsg} className="bg-slate-900 p-2 rounded-2xl flex gap-2 m-2 border border-white/10 shadow-inner">
                <input value={input} onChange={e => setInput(e.target.value)} placeholder="Escreve em Ingl√™s..." className="flex-1 bg-transparent px-4 text-xs focus:outline-none text-white font-medium" />
                <button type="submit" disabled={aiLoading || !input.trim()} className={`w-12 h-12 ${currentTheme.bg} rounded-xl text-slate-900 flex items-center justify-center active:scale-90 transition-all shadow-lg shadow-sky-500/20`}><i className="fas fa-paper-plane text-sm"></i></button>
              </form>
            </div>
          )}

          {view === 'store' && (
            <div className="space-y-6 animate-in slide-up text-center">
              <div className="bg-gradient-to-r from-indigo-700 to-purple-800 p-8 rounded-[2.5rem] text-white space-y-4 shadow-2xl border border-white/10">
                <h3 className="text-2xl font-black italic tracking-tighter uppercase">Premium Pass ‚ú®</h3>
                <p className="text-[11px] opacity-70">Remove an√∫ncios AdMob + Tutor Gemini Ilimitado.</p>
                <button onClick={() => setShowModal('payment')} className="w-full py-4 bg-white text-indigo-900 rounded-2xl font-black uppercase text-xs active:scale-95 transition-all shadow-2xl">Ativar por 14.99‚Ç¨</button>
              </div>
              <div className="p-8 bg-slate-900 border border-white/5 rounded-[2.5rem] space-y-4 shadow-2xl">
                <div className="text-5xl mb-2 animate-bounce">üíé</div>
                <h3 className="font-black text-amber-500 uppercase italic tracking-tighter tracking-widest">Gemas Gr√°tis</h3>
                <p className="text-[10px] opacity-40 font-bold uppercase tracking-widest">Assiste a um v√≠deo!</p>
                <button onClick={handleRewardedAd} className="w-full py-5 bg-amber-500 text-slate-950 rounded-2xl font-black uppercase text-xs active:scale-95 shadow-lg shadow-amber-500/20 transition-all">Ver V√≠deo (+50 üíé)</button>
              </div>
            </div>
          )}

          {view === 'settings' && (
            <div className="space-y-6 animate-in slide-up">
              <h2 className="text-2xl font-black italic uppercase text-center tracking-tighter">Configura√ß√µes ‚öôÔ∏è</h2>
              <div className="p-8 bg-slate-900 border border-white/5 rounded-[2.5rem] space-y-8 shadow-2xl">
                <div>
                  <p className="text-[10px] font-black uppercase tracking-widest opacity-50 mb-4 font-mono">Interface</p>
                  <div className="flex justify-between gap-2">
                    {['emerald', 'white', 'black', 'pink', 'red'].map(c => (
                      <button 
                        key={c} 
                        onClick={() => setAccentColor(c)} 
                        className={`w-10 h-10 rounded-xl border-2 ${accentColor === c ? 'border-sky-400 scale-110' : 'border-transparent'} 
                          ${c === 'emerald' ? 'bg-emerald-500' : c === 'white' ? 'bg-white' : c === 'black' ? 'bg-slate-950 border border-white/20' : c === 'pink' ? 'bg-pink-500' : 'bg-red-600'}`}
                      />
                    ))}
                  </div>
                </div>
                <div className="space-y-4 pt-6 border-t border-white/5">
                   <button onClick={() => setShowModal('terms')} className="w-full text-left text-[10px] font-black uppercase opacity-60 flex justify-between">Termos <i className="fas fa-chevron-right text-[8px]"></i></button>
                   <button onClick={() => setShowModal('privacy')} className="w-full text-left text-[10px] font-black uppercase opacity-60 flex justify-between">Privacidade <i className="fas fa-chevron-right text-[8px]"></i></button>
                </div>
                <div className="pt-6 border-t border-white/5">
                  <button onClick={handleLogout} className="w-full py-4 bg-rose-500/10 text-rose-500 border border-rose-500/20 rounded-2xl font-black uppercase text-xs tracking-widest active:scale-95 transition-all">Sair</button>
                </div>
              </div>
            </div>
          )}
        </main>

        <nav className="fixed bottom-0 left-0 right-0 p-6 flex justify-around border-t z-50 bg-[#020617]/95 border-white/5 backdrop-blur-2xl">
          {[{id:'home', i:'home', l:'Aulas'}, {id:'ranking', i:'trophy', l:'Rank'}, {id:'tutor', i:'robot', l:'IA'}, {id:'store', i:'gem', l:'Loja'}].map(tab => (
            <button key={tab.id} onClick={() => setView(tab.id)} className={`flex flex-col items-center gap-1 transition-all duration-500 ${view === tab.id ? currentTheme.text + ' scale-125' : 'opacity-30 grayscale'}`}>
              <i className={`fas fa-${tab.i} text-lg`}></i>
              <span className="text-[7px] font-black uppercase tracking-tighter">{String(tab.l)}</span>
            </button>
          ))}
        </nav>
      </div>

      {showModal && (
        <div className="fixed inset-0 bg-black/95 backdrop-blur-3xl z-[100] flex items-center justify-center p-6 animate-in fade-in">
          <div className="bg-[#0f172a] w-full max-w-sm rounded-[3.5rem] p-10 text-center border border-white/10 shadow-4xl relative overflow-hidden">
            <h3 className={`text-xl font-black mb-4 uppercase tracking-tighter ${currentTheme.text}`}>{showModal === 'payment' ? 'Subscri√ß√£o' : 'Aviso Legal'}</h3>
            <p className="text-[10px] text-slate-400 leading-relaxed mb-10 font-medium text-justify">
               {showModal === 'terms' ? 'Ao utilizar o LingoQuest Pro, o utilizador concorda que o seu progresso √© guardado na nuvem e partilhado no ranking global para incentivar a competi√ß√£o saud√°vel entre alunos.' : 
                showModal === 'privacy' ? 'Os teus dados pessoais, como nome de utilizador e pontua√ß√£o XP, s√£o armazenados de forma segura. N√£o partilhamos dados com terceiros al√©m dos servi√ßos AdMob para publicidade.' : 
                'Pagamento seguro via Google Play. O progresso √© sincronizado na nuvem para garantir a tua posi√ß√£o no ranking global.'}
            </p>
            <button onClick={() => setShowModal(null)} className={`w-full py-5 ${currentTheme.bg} text-slate-950 rounded-2xl font-black uppercase text-xs tracking-widest active:scale-95 transition-all shadow-lg`}>Entendido</button>
          </div>
        </div>
      )}

      <style>{`
        .animate-in { animation: fadeIn 0.4s ease-out; }
        .slide-up { animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
      `}</style>
    </div>
  );
}