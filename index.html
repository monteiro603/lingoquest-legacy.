<!-- Chosen Palette: Deep Dark & Electric Sky (Background: #020617, Primary: #0EA5E9, Accent: #10B981) -->
<!-- Vers√£o: Monetiza√ß√£o AdMob + Dark Mode + IA Robustecida (Retry Logic) -->

<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LingoQuest Pro: Legacy - Ads Ready</title>
    
    <!-- PWA Essentials -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" id="theme-meta" content="#020617">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/3892/3892250.png">

    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap');
        
        :root { 
            --primary: #0EA5E9; 
            --bg-deep: #020617; 
            --card-dark: #1E293B;
            --text-main: #F8FAFC;
        }

        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: var(--bg-deep); 
            color: var(--text-main);
            min-height: 100vh; 
            transition: all 0.3s ease; 
            -webkit-tap-highlight-color: transparent;
        }
        
        .glass { 
            background: rgba(30, 41, 59, 0.7); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
        }

        .nav-active { color: var(--primary); transform: translateY(-4px); }
        
        .card-inner { 
            position: relative; 
            width: 100%; 
            height: 320px; 
            transition: transform 0.6s; 
            transform-style: preserve-3d; 
            cursor: pointer; 
        }
        .card-inner.is-flipped { transform: rotateY(180deg); }
        .card-face { 
            position: absolute; 
            width: 100%; 
            height: 100%; 
            backface-visibility: hidden; 
            border-radius: 32px; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            padding: 2rem; 
            background: #1E293B; 
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.3);
        }
        .card-back { 
            background: var(--primary); 
            color: #020617; 
            transform: rotateY(180deg); 
            border: none; 
        }
        
        .chat-bubble { 
            max-width: 90%; 
            padding: 14px 18px; 
            border-radius: 24px; 
            font-size: 14px; 
            line-height: 1.6; 
            white-space: pre-wrap; 
        }
        .bubble-bot { background: #1E293B; color: #F8FAFC; border: 1px solid rgba(255,255,255,0.05); }
        .bubble-user { background: var(--primary); color: #020617; align-self: flex-end; font-weight: 600; }
        
        .view-animate { animation: fadeInUp 0.4s ease-out; }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        .ai-loading { display: inline-block; width: 18px; height: 18px; border: 3px solid rgba(255,255,255,0.1); border-radius: 50%; border-top-color: var(--primary); animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .ad-banner-container { width: 100%; height: 60px; background: #0F172A; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; font-size: 9px; color: #475569; letter-spacing: 2px; }
        .ad-simulation-overlay { position: fixed; inset: 0; z-index: 200; background: #000; display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; }
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(8px); z-index: 300; display: flex; align-items: center; justify-content: center; padding: 1.5rem; }
        input { background: #0F172A !important; border: 1px solid #334155 !important; padding: 12px 16px; border-radius: 12px; font-size: 14px; color: white !important; outline: none; }
    </style>
</head>
<body class="pb-32">

    <div id="ad-banner-top" class="ad-banner-container">ADMOB BANNER SPACE</div>

    <div id="modal-container" class="modal-overlay hidden">
        <div class="bg-[#1E293B] rounded-[2.5rem] w-full max-w-sm p-8 shadow-2xl border border-white/5 text-center">
            <h3 id="modal-title" class="text-xl font-black mb-2 text-white">Confirmar</h3>
            <p id="modal-text" class="text-sm text-slate-400 mb-8 leading-relaxed"></p>
            <div class="flex space-x-3">
                <button onclick="closeModal()" class="flex-1 py-4 bg-slate-800 text-slate-300 rounded-2xl font-bold">Cancelar</button>
                <button id="modal-confirm-btn" class="flex-1 py-4 bg-sky-500 text-slate-900 rounded-2xl font-bold shadow-lg">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="toast-notif" class="fixed top-12 left-1/2 -translate-x-1/2 z-[400] bg-white text-slate-900 px-6 py-3 rounded-full text-xs font-bold shadow-2xl hidden"></div>

    <div id="auth-screen" class="fixed inset-0 z-[100] bg-[#020617] flex flex-col items-center justify-center p-8 overflow-y-auto">
        <div class="w-full max-w-sm text-center">
            <div class="mb-10">
                <svg class="w-16 h-16 mx-auto mb-6" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="50" cy="50" r="50" fill="#0EA5E9"/>
                    <path d="M30 50L45 65L70 35" stroke="#020617" stroke-width="8" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
                <h1 class="text-4xl font-black text-white tracking-tighter mb-2">LingoQuest<br><span class="text-emerald-500 text-3xl uppercase tracking-widest">Pro Edition</span></h1>
                <p class="text-slate-500 text-sm italic">Aprende ingl√™s t√©cnico e domina o mercado.</p>
            </div>
            <div class="flex bg-[#1E293B] p-1 rounded-2xl mb-8">
                <button onclick="toggleAuthMode('login')" id="tab-login" class="flex-1 py-3 text-xs font-bold rounded-xl bg-slate-800 text-white shadow-sm transition-all">Login</button>
                <button onclick="toggleAuthMode('register')" id="tab-register" class="flex-1 py-3 text-xs font-bold text-slate-500 transition-all">Registo</button>
            </div>
            <div class="flex flex-col space-y-4 mb-8">
                <input type="email" id="auth-email" placeholder="E-mail">
                <input type="password" id="auth-password" placeholder="Password">
                <button id="btn-auth-submit" class="w-full py-5 bg-sky-500 text-slate-900 rounded-2xl font-black text-sm uppercase shadow-xl active:scale-95 transition-all">Come√ßar Agora</button>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <button id="btn-login-google" class="py-4 px-4 bg-[#1E293B] border border-white/5 rounded-2xl text-white font-bold text-xs">Google</button>
                <button id="btn-login-guest" class="py-4 px-4 bg-slate-800 rounded-2xl text-slate-300 font-bold text-xs">Convidado</button>
            </div>
            <p id="auth-error-msg" class="mt-6 text-[10px] text-rose-500 font-bold hidden"></p>
        </div>
    </div>

    <div id="main-ui" class="hidden">
        <header class="p-6 flex justify-between items-center glass sticky top-0 z-40 border-b border-white/5">
            <div id="header-logo-container" class="cursor-pointer">
                <h1 class="text-2xl font-black text-white tracking-tighter leading-none">LingoQuest <span class="text-emerald-500">Pro</span></h1>
                <div class="flex items-center space-x-2 mt-1"><div class="bg-orange-600 text-white px-2 py-0.5 rounded text-[8px] font-bold">üî• <span id="ui-streak">0</span></div></div>
            </div>
            <div class="flex items-center space-x-2"><div class="bg-amber-500/10 px-4 py-2 rounded-2xl text-amber-500 font-black text-sm border border-amber-500/20">üíé <span id="ui-gems">0</span></div></div>
        </header>
        <main id="app-viewport" class="px-6 py-6 max-w-lg mx-auto min-h-[60vh]"></main>
        <nav class="fixed bottom-0 left-0 right-0 bg-[#020617] border-t border-white/5 px-8 py-5 flex justify-between items-center z-50 shadow-2xl">
            <button onclick="changeView('home')" id="nav-home" class="flex flex-col items-center transition-all nav-active"><span class="text-2xl">üè†</span></button>
            <button onclick="changeView('flashcards')" id="nav-flashcards" class="flex flex-col items-center transition-all text-slate-600"><span class="text-2xl">üìö</span></button>
            <button onclick="changeView('tutor')" id="nav-tutor" class="flex flex-col items-center transition-all text-slate-600"><span class="text-2xl">ü§ñ</span></button>
            <button onclick="changeView('grammar')" id="nav-grammar" class="flex flex-col items-center transition-all text-slate-600"><span class="text-2xl">‚úçÔ∏è</span></button>
            <button onclick="changeView('store')" id="nav-store" class="flex flex-col items-center transition-all text-slate-600"><span class="text-2xl">üè™</span></button>
            <button onclick="changeView('settings')" id="nav-settings" class="flex flex-col items-center transition-all text-slate-600"><span class="text-2xl">‚öôÔ∏è</span></button>
        </nav>
    </div>

    <div id="ad-overlay" class="ad-simulation-overlay hidden">
        <div class="absolute top-10 right-10 text-xs font-bold text-white/30" id="ad-timer">An√∫ncio acaba em 5s...</div>
        <div class="text-center p-8">
            <div class="text-7xl mb-8">üì∫</div>
            <h3 class="text-2xl font-black mb-4 uppercase tracking-tighter">Publicidade Premiada</h3>
            <p class="text-sm text-slate-500 mb-10 italic max-w-xs mx-auto">V√™ este v√≠deo para ganhares 50 gemas!</p>
            <div class="w-64 h-1.5 bg-white/10 rounded-full overflow-hidden mx-auto"><div id="ad-progress" class="bg-sky-500 h-full w-0 transition-all duration-[5000ms] ease-linear"></div></div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signInAnonymously, signInWithEmailAndPassword, createUserWithEmailAndPassword, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GEMINI CONFIG ---
        const apiKey = ""; // A chave ser√° providenciada pelo ambiente em execu√ß√£o
        const geminiModel = "gemini-2.5-flash-preview-09-2025";

        // --- Firebase Config ---
        const envConfig = window.__firebase_config ? JSON.parse(window.__firebase_config) : null;
        const firebaseConfig = envConfig || { apiKey: "", authDomain: "", projectId: "", storageBucket: "", messagingSenderId: "", appId: "" };
        const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'lingoquest-pro-dark';
        
        let auth, db;
        if (firebaseConfig.apiKey) {
            try {
                const app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);
            } catch (e) { console.error("Firebase Init", e); }
        }

        let state = {
            user: null, xp: 0, gems: 0, streak: 0, totalTimeMinutes: 0,
            level: 'basic', view: 'home', theme: 'theme-blue', cardIdx: 0,
            chatMessages: [], grammarAnalysis: null,
            unlockedLevels: ['basic'],
            achievements: { 'first_step': true, 'scholar': false, 'master': false }
        };

        const LEVEL_COSTS = { basic: 0, intermediate: 200, advanced_tech: 500 };
        const GAME_DATA = {
            basic: { cards: [{en: "I am a teacher", pt: "Eu sou professor(a)", cat: "B√°sico"}, {en: "Do you like coffee?", pt: "Gostas de caf√©?", cat: "B√°sico"}] },
            intermediate: { cards: [{en: "I have finished my homework", pt: "Eu terminei o meu TPC", cat: "Interm√©dio"}] },
            advanced_tech: { cards: [{en: "To charter", pt: "Fretar (Navio/Carga)", cat: "Avan√ßado T√©cnico"}, {en: "Toxic Gas", pt: "G√°s T√≥xico", cat: "Dangerous Cargo"}] }
        };

        // --- IA Implementation (Exponential Backoff) ---
        async function callGemini(prompt, sys) {
            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                systemInstruction: { parts: [{ text: "Tutor LingoQuest Pro. " + sys }] }
            };
            
            const delays = [1000, 2000, 4000, 8000, 16000];
            
            for (let i = 0; i <= delays.length; i++) {
                try {
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/${geminiModel}:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        return data.candidates?.[0]?.content?.parts?.[0]?.text || "Erro: Resposta vazia.";
                    }
                    
                    if (i === delays.length) throw new Error("Falha ap√≥s retentativas.");
                } catch (e) {
                    if (i === delays.length) return "O servidor da IA est√° ocupado. Tente novamente em alguns segundos.";
                }
                
                // Aguarda o atraso definido antes da pr√≥xima tentativa
                await new Promise(resolve => setTimeout(resolve, delays[i]));
            }
        }

        // --- Auth Logic ---
        let authMode = 'login';
        window.toggleAuthMode = (mode) => {
            authMode = mode;
            const btn = document.getElementById('btn-auth-submit');
            const tabLogin = document.getElementById('tab-login');
            const tabRegister = document.getElementById('tab-register');
            if (mode === 'login') {
                btn.textContent = 'Entrar';
                tabLogin.className = 'flex-1 py-3 text-xs font-bold rounded-xl bg-slate-800 text-white';
                tabRegister.className = 'flex-1 py-3 text-xs font-bold text-slate-500';
            } else {
                btn.textContent = 'Criar Conta';
                tabRegister.className = 'flex-1 py-3 text-xs font-bold rounded-xl bg-slate-800 text-white';
                tabLogin.className = 'flex-1 py-3 text-xs font-bold text-slate-500';
            }
        };

        if (auth) {
            onAuthStateChanged(auth, (user) => {
                if (user) { 
                    state.user = user; syncUserData(user.uid); 
                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('main-ui').classList.remove('hidden');
                    changeView('home');
                } else { 
                    document.getElementById('auth-screen').classList.remove('hidden');
                    document.getElementById('main-ui').classList.add('hidden');
                }
            });
        }

        document.getElementById('btn-auth-submit').onclick = async () => {
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            if (!email || password.length < 6) return showError("E-mail ou password inv√°lida.");
            try {
                if (authMode === 'login') await signInWithEmailAndPassword(auth, email, password);
                else await createUserWithEmailAndPassword(auth, email, password);
            } catch (e) { showError(e.message); }
        };

        document.getElementById('btn-login-guest').onclick = () => {
            if (auth) signInAnonymously(auth); else enterGuestMode();
        };

        function enterGuestMode() {
            document.getElementById('auth-screen').classList.add('hidden');
            document.getElementById('main-ui').classList.remove('hidden');
            changeView('home');
        }

        const showError = (msg) => {
            const el = document.getElementById('auth-error-msg');
            el.textContent = msg; el.classList.remove('hidden');
            setTimeout(() => el.classList.add('hidden'), 5000);
        };

        // --- Data Handling ---
        async function syncUserData(uid) {
            if (!db) return;
            const userDocRef = doc(db, 'artifacts', appId, 'users', uid, 'profile', 'data');
            onSnapshot(userDocRef, (docSnap) => {
                if (docSnap.exists()) { 
                    const data = docSnap.data();
                    const { user, ...rest } = data; 
                    Object.assign(state, rest); 
                    updateUI(); 
                } else { saveData(); }
            });
        }

        async function saveData() {
            if (!state.user || !db) return;
            const userDocRef = doc(db, 'artifacts', appId, 'users', state.user.uid, 'profile', 'data');
            const dataToSave = { ...state };
            delete dataToSave.user; 
            try { await setDoc(userDocRef, { ...dataToSave, updatedAt: new Date().toISOString() }, { merge: true }); } catch (e) { }
        }

        // --- App Views ---
        window.changeView = (view) => {
            state.view = view;
            const viewport = document.getElementById('app-viewport');
            document.querySelectorAll('nav button').forEach(b => {
                b.classList.remove('nav-active'); b.classList.add('text-slate-600');
            });
            const navBtn = document.getElementById(`nav-${view}`);
            if (navBtn) { navBtn.classList.add('nav-active'); navBtn.classList.remove('text-slate-600'); }
            viewport.innerHTML = '';
            updateUI();
            
            switch(view) {
                case 'home': renderHome(viewport); break;
                case 'flashcards': renderFlashcards(viewport); break;
                case 'tutor': renderTutor(viewport); break;
                case 'grammar': renderGrammar(viewport); break;
                case 'store': renderStore(viewport); break;
                case 'settings': renderSettings(viewport); break;
                case 'terms': renderTerms(viewport); break;
            }
        };

        function renderHome(v) {
            v.innerHTML = `
                <div class="view-animate">
                    <div class="bg-gradient-to-br from-sky-600 to-sky-900 rounded-[2.5rem] p-10 text-white shadow-2xl mb-8 relative overflow-hidden">
                        <h2 class="text-3xl font-black mb-1 italic">N√≠vel ${state.level.split('_')[0].toUpperCase()}</h2>
                        <p class="text-sky-300 text-[10px] uppercase font-bold tracking-widest">XP: ${state.xp}</p>
                        <div class="mt-8 bg-black/30 h-1.5 rounded-full overflow-hidden"><div class="bg-emerald-400 h-full" style="width: ${(state.xp % 100)}%"></div></div>
                    </div>
                    <div class="grid grid-cols-1 gap-5">
                        ${renderLevelBtn('basic', 'üå±', 'B√°sico')}
                        ${renderLevelBtn('intermediate', 'üèÜ', 'Interm√©dio')}
                        ${renderLevelBtn('advanced_tech', 'üö¢', 'Avan√ßado T√©cnico')}
                    </div>
                </div>
            `;
        }

        function renderLevelBtn(id, icon, label) {
            const isUnlocked = state.unlockedLevels.includes(id);
            const cost = LEVEL_COSTS[id];
            return `
                <button onclick="handleLevelSelection('${id}')" class="p-8 bg-[#1E293B] rounded-[2rem] border border-white/5 ${isUnlocked ? 'border-sky-500/20' : 'opacity-60'} flex items-center justify-between">
                    <div class="text-left"><p class="font-black text-white uppercase text-xs tracking-wider">${label}</p><p class="text-[9px] text-slate-500 mt-1">${isUnlocked ? 'ESTUDAR AGORA' : 'BLOQUEADO: ' + cost + ' üíé'}</p></div>
                    <span class="text-3xl">${isUnlocked ? icon : 'üîí'}</span>
                </button>
            `;
        }

        window.handleLevelSelection = (lvlId) => {
            if (state.unlockedLevels.includes(lvlId)) { state.level = lvlId; state.cardIdx = 0; changeView('flashcards'); }
            else {
                const cost = LEVEL_COSTS[lvlId];
                if (state.gems >= cost) {
                    document.getElementById('modal-text').textContent = `Desejas desbloquear este curso por ${cost} gemas?`;
                    document.getElementById('modal-container').classList.remove('hidden');
                    document.getElementById('modal-confirm-btn').onclick = () => {
                        state.gems -= cost; state.unlockedLevels.push(lvlId); 
                        closeModal(); showToast("Curso Desbloqueado! üîì"); updateUI(); saveData(); changeView('home');
                    };
                } else { showToast("Gemas insuficientes!"); changeView('store'); }
            }
        };

        function renderFlashcards(v) {
            const card = GAME_DATA[state.level].cards[state.cardIdx];
            v.innerHTML = `
                <div class="view-animate text-center">
                    <div id="card-box" class="card-container mb-10">
                        <div class="card-inner">
                            <div class="card-face"><span class="text-[10px] font-bold text-sky-500 mb-8 uppercase tracking-widest">${card.cat}</span><h3 class="text-4xl font-black text-white px-4">${card.en}</h3><p class="mt-10 text-slate-500 text-[10px]">Toca para traduzir</p></div>
                            <div class="card-back card-face"><span class="text-[10px] font-bold text-slate-900 mb-8 uppercase tracking-widest">Portugu√™s</span><h3 class="text-3xl font-bold text-slate-900 px-4">${card.pt}</h3></div>
                        </div>
                    </div>
                    <button id="btn-next" class="w-full py-5 bg-sky-500 text-slate-900 rounded-3xl font-black shadow-lg">PR√ìXIMO (+10 XP)</button>
                </div>
            `;
            document.getElementById('card-box').onclick = () => {
                const inner = document.querySelector('.card-inner');
                if (inner) inner.classList.toggle('is-flipped');
                const u = new SpeechSynthesisUtterance(card.en); u.lang = 'en-US'; window.speechSynthesis.speak(u);
            };
            document.getElementById('btn-next').onclick = () => {
                state.xp += 10; state.cardIdx = (state.cardIdx + 1) % GAME_DATA[state.level].cards.length;
                changeView('flashcards'); saveData();
            };
        }

        function renderTutor(v) {
            v.innerHTML = `
                <div class="view-animate flex flex-col h-full" style="height: calc(100vh - 280px);">
                    <div id="chat-win" class="flex-1 overflow-y-auto space-y-4 p-4 bg-[#1E293B]/30 rounded-[2.5rem] border border-white/5 min-h-[350px]">
                        ${state.chatMessages.map(m => `<div class="flex ${m.role === 'user' ? 'justify-end' : 'justify-start'}"><div class="chat-bubble ${m.role === 'user' ? 'bubble-user' : 'bubble-bot'} shadow-lg animate-fade-in">${m.text}</div></div>`).join('') || '<p class="text-center py-24 text-slate-600 text-xs italic">Conversa em ingl√™s com o Tutor Pro.</p>'}
                    </div>
                    <div class="mt-6 flex space-x-3 bg-[#1E293B] p-3 rounded-2xl shadow-xl border border-white/5">
                        <input id="chat-in" type="text" placeholder="Diz algo..." class="flex-1 p-4 bg-transparent border-none text-sm text-white">
                        <button id="btn-send" class="p-4 px-8 bg-sky-500 text-slate-900 rounded-xl font-black shadow-lg">Enviar</button>
                    </div>
                </div>
            `;
            const win = document.getElementById('chat-win');
            if (win) win.scrollTop = 9999;
            document.getElementById('btn-send').onclick = async () => {
                const input = document.getElementById('chat-in');
                const text = input.value.trim(); if (!text) return;
                state.chatMessages.push({ role: 'user', text }); input.value = '';
                renderTutor(document.getElementById('app-viewport'));
                
                const response = await callGemini(text, "Responde de forma amig√°vel em Portugu√™s sobre Ingl√™s.");
                state.chatMessages.push({ role: 'bot', text: response });
                renderTutor(document.getElementById('app-viewport'));
            };
        }

        function renderGrammar(v) {
            v.innerHTML = `
                <div class="view-animate">
                    <h2 class="text-3xl font-black mb-6">Corre√ß√£o IA ‚ú®</h2>
                    <textarea id="gram-in" placeholder="Ex: I has a ship..." class="w-full h-40 p-6 rounded-[2.5rem] bg-[#1E293B] border border-white/5 outline-none text-sm mb-6 text-white focus:border-sky-500 transition-all"></textarea>
                    <button id="btn-gram" class="w-full py-5 bg-sky-500 text-slate-900 rounded-3xl font-black shadow-lg uppercase">Analisar Erros</button>
                    <div id="gram-res" class="mt-10 ${state.grammarAnalysis ? '' : 'hidden'} pb-12">
                        <div class="bg-[#1E293B] p-8 rounded-[2.5rem] border border-white/5 text-sm text-slate-300 leading-relaxed shadow-2xl">${state.grammarAnalysis || ''}</div>
                    </div>
                </div>
            `;
            document.getElementById('btn-gram').onclick = async () => {
                const input = document.getElementById('gram-in').value; if (!input) return;
                document.getElementById('btn-gram').innerHTML = '<div class="ai-loading"></div>';
                state.grammarAnalysis = await callGemini(`Corrige e explica: "${input}".`, "Foca na gram√°tica mar√≠tima se poss√≠vel.");
                renderGrammar(document.getElementById('app-viewport'));
            };
        }

        function renderStore(v) {
            v.innerHTML = `
                <div class="view-animate">
                    <h2 class="text-3xl font-black mb-8 text-center text-white text-emerald-500">Loja üíé</h2>
                    <div class="bg-gradient-to-br from-emerald-600 to-emerald-900 rounded-[2.5rem] p-10 text-white shadow-2xl mb-8 relative overflow-hidden">
                        <div class="relative z-10 text-center">
                            <h3 class="font-black text-2xl mb-2">Gemas Gr√°tis</h3>
                            <button onclick="watchAdReward()" class="w-full py-5 bg-white text-emerald-900 rounded-3xl font-black text-sm uppercase mt-4">Ver An√∫ncio (+50 üíé)</button>
                        </div>
                    </div>
                </div>
            `;
        }

        window.watchAdReward = () => {
            const overlay = document.getElementById('ad-overlay');
            if (overlay) {
                overlay.classList.remove('hidden');
                setTimeout(() => {
                    overlay.classList.add('hidden');
                    state.gems += 50; showToast("+50 Gemas! üíé"); updateUI(); saveData();
                }, 5000);
            }
        };

        function renderSettings(v) {
            v.innerHTML = `
                <div class="view-animate space-y-8">
                    <h2 class="text-3xl font-black">Defini√ß√µes ‚öôÔ∏è</h2>
                    <div class="bg-[#1E293B] p-8 rounded-[2.5rem] border border-white/5">
                        <p class="text-[10px] font-black text-sky-500 uppercase mb-4 tracking-widest">Utilizador</p>
                        <p class="text-sm text-slate-400 mb-8 font-medium">${state.user?.email || "Convidado"}</p>
                        <div class="space-y-3">
                            <button onclick="changeView('terms')" class="w-full py-4 bg-slate-800 text-white rounded-2xl font-bold text-sm">Termos</button>
                            <button onclick="handleLogout()" class="w-full py-4 bg-rose-950/20 text-rose-500 rounded-2xl font-bold text-sm border border-rose-900/30">Sair</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderTerms(v) {
            v.innerHTML = `
                <div class="view-animate pb-12">
                    <div class="flex items-center space-x-4 mb-8">
                        <button onclick="changeView('settings')" class="text-sky-500 font-black text-lg">‚Üê</button>
                        <h2 class="text-2xl font-black">Termos</h2>
                    </div>
                    <div class="bg-[#1E293B] p-8 rounded-[2.5rem] border border-white/5 text-xs text-slate-400 leading-relaxed">
                        As gemas s√£o virtuais e n√£o t√™m valor real. O Tutor IA pode conter imprevistos.
                    </div>
                </div>
            `;
        }

        window.handleLogout = () => { if(auth) signOut(auth); else location.reload(); };
        window.showToast = (msg) => {
            const t = document.getElementById('toast-notif');
            if (t) { t.textContent = msg; t.classList.remove('hidden'); }
            setTimeout(() => t && t.classList.add('hidden'), 3000);
        };
        window.closeModal = () => { document.getElementById('modal-container').classList.add('hidden'); };
        function updateUI() {
            const g = document.getElementById('ui-gems');
            if(g) g.textContent = state.gems;
        }

        if ('serviceWorker' in navigator && (window.location.protocol === 'http:' || window.location.protocol === 'https:')) {
            window.addEventListener('load', () => { navigator.serviceWorker.register('./service-worker.js').catch(() => {}); });
        }
    </script>
</body>
</html>